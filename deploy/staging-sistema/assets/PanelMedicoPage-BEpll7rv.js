import{r as x,j as e,n as E,S as _}from"./vendor-B5yQt2qK.js";import{u as M}from"./useDisponibilidadMedico-BnDsnWx8.js";import{S as L}from"./Spinner-4kDqlTQV.js";import{B as S}from"./examenes-laboratorio-crud-BJk1fG4Z.js";function B({onSave:k,bloquesGuardados:g=[]}){const[d,y]=x.useState([]),[h,i]=x.useState({}),[r,j]=x.useState(null),v=new Set(g.map(t=>t.fecha)),f=t=>new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().slice(0,10),m=t=>{const s=new Date,n=new Date(t);return s.setHours(0,0,0,0),n.setHours(0,0,0,0),n<s},N=t=>{let s=Array.isArray(t)?t:[t];s=s.map(n=>f(n)),s=s.filter(n=>!m(n)),y(s),i(n=>{const a={...n};return s.forEach(o=>{a[o]||(a[o]=[{hora_inicio:"08:00:00",hora_fin:"10:00:00"}])}),Object.keys(a).forEach(o=>{s.includes(o)||delete a[o]}),a})},D=t=>{const s=f(t);m(s)&&!v.has(s)||(j(s),!d.includes(s)&&!m(s)&&(y(n=>[...n,s]),i(n=>({...n,[s]:[{hora_inicio:"08:00:00",hora_fin:"10:00:00"}]}))))},p=(t,s,n,a)=>{i(o=>{const l={...o};return l[t][s][n]=a,{...l}})},u=t=>{i(s=>{const n={...s};return n[t]=[...n[t],{hora_inicio:"08:00:00",hora_fin:"10:00:00"}],n})},w=(t,s)=>{i(n=>{const a={...n};return a[t]=a[t].filter((o,l)=>l!==s),a})},C=()=>{const t=[];Object.entries(h).forEach(([s,n])=>{n.forEach(a=>t.push({fecha:s,...a}))}),k&&k(t)};return e.jsxs("div",{className:"max-w-xl mx-auto p-4 border rounded shadow bg-white",children:[e.jsx("h2",{className:"font-bold text-lg mb-2 text-center",children:"Definir Disponibilidad"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block mb-1 font-semibold",children:"Selecciona fechas:"}),e.jsx(E,{onChange:N,value:d.length===1?new Date(d[0]):d.map(t=>new Date(t)),selectRange:!1,minDetail:"month",maxDetail:"month",allowPartialRange:!1,showNeighboringMonth:!1,locale:"es-ES",selectMultiple:!0,tileClassName:({date:t})=>{const s=f(t);let n=[];return d.includes(s)&&n.push("selected-multiple"),h[s]&&h[s].length>0&&n.push("has-bloques"),v.has(s)&&(m(s)?n.push("fecha-pasada"):n.push("fecha-registrada")),n.join(" ")},onClickDay:D}),e.jsxs("div",{className:"mt-3 p-2 bg-gray-50 rounded text-xs",children:[e.jsx("div",{className:"font-semibold mb-1 text-gray-700",children:"Leyenda:"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-green-100 border-2 border-green-500 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-green-500 text-xs font-bold",children:"✓"})}),e.jsx("span",{children:"Ya registrado"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-100 border-2 border-gray-400 rounded flex items-center justify-center opacity-70",children:e.jsx("span",{className:"text-gray-500 text-xs font-bold",children:"⏰"})}),e.jsx("span",{children:"Consulta pasada"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-sky-400 rounded"}),e.jsx("span",{children:"Seleccionado"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-100 border border-blue-300 rounded"}),e.jsx("span",{children:"Hoy"})]})]})]})]}),d.length===0&&e.jsx("div",{className:"text-gray-500 text-sm mb-2",children:"Selecciona al menos una fecha en el calendario."}),r&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 min-w-[320px] max-w-md relative",children:[e.jsx("button",{onClick:()=>j(null),className:"absolute top-2 right-2 text-gray-500 hover:text-red-500 text-xl font-bold","aria-label":"Cerrar",children:"×"}),e.jsxs("div",{className:"font-semibold mb-2 text-blue-700",children:["Bloques para ",r]}),h[r]&&h[r].map((t,s)=>e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("input",{type:"time",value:t.hora_inicio,onChange:n=>p(r,s,"hora_inicio",n.target.value+":00"),className:"border rounded px-2 py-1",step:"1800"}),e.jsx("span",{children:"a"}),e.jsx("input",{type:"time",value:t.hora_fin,onChange:n=>p(r,s,"hora_fin",n.target.value+":00"),className:"border rounded px-2 py-1",step:"1800"}),e.jsx("button",{type:"button",onClick:()=>w(r,s),className:"text-red-600 hover:underline",children:"Eliminar"})]},s)),e.jsx("button",{type:"button",onClick:()=>u(r),className:"text-blue-600 hover:underline text-sm mt-1",children:"+ Agregar otro horario"}),e.jsx("button",{onClick:()=>j(null),className:"bg-blue-600 text-white px-4 py-2 rounded font-bold w-full mt-4",children:"Cerrar"})]})}),d.length>0&&!r&&d.map(t=>e.jsxs("div",{className:"mb-4 border rounded p-2 bg-gray-50",children:[e.jsx("div",{className:"font-semibold mb-1",children:t}),h[t].map((s,n)=>e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("input",{type:"time",value:s.hora_inicio,onChange:a=>p(t,n,"hora_inicio",a.target.value+":00"),className:"border rounded px-2 py-1",step:"1800"}),e.jsx("span",{children:"a"}),e.jsx("input",{type:"time",value:s.hora_fin,onChange:a=>p(t,n,"hora_fin",a.target.value+":00"),className:"border rounded px-2 py-1",step:"1800"}),e.jsx("button",{type:"button",onClick:()=>w(t,n),className:"text-red-600 hover:underline",children:"Eliminar"})]},n)),e.jsx("button",{type:"button",onClick:()=>u(t),className:"text-blue-600 hover:underline text-sm mt-1",children:"+ Agregar otro horario"})]},t)),e.jsx("button",{onClick:C,className:"bg-blue-600 text-white px-4 py-2 rounded font-bold w-full mt-2",children:"Guardar Disponibilidad"})]})}function H(){const g=JSON.parse(sessionStorage.getItem("medico")||"null")?.id,{deleteDisponibilidad:d,saveDisponibilidad:y}=M(g),h=async a=>{await d(a),u()},[i,r]=x.useState({open:!1,bloque:null}),j=a=>{r({open:!0,bloque:a})},v=async()=>{i.bloque&&(await y(i.bloque,i.bloque.id),r({open:!1,bloque:null}),u())},f=(a,o)=>{r(l=>({...l,bloque:{...l.bloque,[a]:o}}))},[m,N]=x.useState([]),[D,p]=x.useState(!1),u=x.useCallback(async()=>{p(!0);try{const o=await(await fetch(`${S}api_disponibilidad_medicos.php?medico_id=${g}`)).json();N(o.disponibilidad||[])}catch{N([])}p(!1)},[g]);x.useEffect(()=>{u()},[u]);const w=async a=>{try{(await(await fetch(`${S}api_disponibilidad_medicos.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({medico_id:g,bloques:a})})).json()).success?(_.fire({icon:"success",title:"Disponibilidad guardada correctamente",showConfirmButton:!1,timer:1400}),u()):_.fire({icon:"error",title:"Error al guardar disponibilidad"})}catch{_.fire({icon:"error",title:"Error de red o servidor"})}},C=m.reduce((a,o)=>(a[o.fecha]||(a[o.fecha]=[]),a[o.fecha].push(o),a),{}),t=Object.keys(C).sort((a,o)=>new Date(o)-new Date(a)),s=a=>a?.slice(0,5),n=a=>{const o=new Date,l=new Date(a);return o.setHours(0,0,0,0),l.setHours(0,0,0,0),l<o};return e.jsxs("div",{className:"max-w-6xl mx-auto mt-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-8 text-center col-span-2",children:"Panel del Médico"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-8",children:[e.jsx("div",{className:"md:w-1/2 w-full",children:e.jsx(B,{onSave:w,bloquesGuardados:m})}),e.jsxs("div",{className:"md:w-1/2 w-full max-h-[70vh] overflow-y-auto bg-white rounded-lg shadow-inner",children:[e.jsxs("h2",{className:"font-bold text-lg mb-2 flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),"Disponibilidad registrada"]}),D?e.jsx("div",{className:"text-center py-4",children:e.jsx(L,{message:"Cargando disponibilidad registrada..."})}):t.length===0?e.jsx("div",{className:"text-gray-500 text-center py-6",children:"No hay bloques registrados aún."}):e.jsx("div",{className:"space-y-6",children:t.map(a=>{const o=n(a),l=[...C[a]].sort((c,b)=>c.hora_inicio.localeCompare(b.hora_inicio));return e.jsxs("div",{className:`rounded-lg shadow p-4 ${o?"bg-gray-50 border-l-4 border-gray-400":"bg-blue-50"}`,children:[e.jsxs("div",{className:`font-semibold mb-2 flex items-center gap-2 ${o?"text-gray-600":"text-blue-700"}`,children:[o?e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}):e.jsx("svg",{className:"w-4 h-4 text-blue-400",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),(()=>{const[c,b,q]=a.split("-");return new Date(Number(c),Number(b)-1,Number(q)).toLocaleDateString()})(),o&&e.jsx("span",{className:"text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full ml-2",children:"Consulta pasada"})]}),e.jsxs("table",{className:`min-w-full text-sm border rounded overflow-hidden ${o?"opacity-70":""}`,children:[e.jsx("thead",{className:`${o?"bg-gray-200":"bg-blue-100"}`,children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-1",children:"Hora inicio"}),e.jsx("th",{className:"px-2 py-1",children:"Hora fin"}),e.jsx("th",{className:"px-2 py-1 text-center",children:o?"Historial":"Acciones"})]})}),e.jsx("tbody",{children:l.map(c=>e.jsxs("tr",{className:`${o?"hover:bg-gray-100":"hover:bg-blue-200"} transition group`,children:[e.jsx("td",{className:"px-2 py-1 text-center font-mono text-green-700",children:s(c.hora_inicio)}),e.jsx("td",{className:"px-2 py-1 text-center font-mono text-red-700",children:s(c.hora_fin)}),e.jsx("td",{className:"px-2 py-1 text-center flex gap-1 justify-center",children:o?e.jsx("span",{className:"text-xs text-gray-500 px-2 py-1 bg-gray-100 rounded",children:"Finalizado"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{title:"Editar",onClick:()=>j(c),className:"text-blue-500 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("svg",{className:"w-5 h-5 inline",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15H9v-2z"})})}),e.jsx("button",{title:"Eliminar",onClick:()=>h(c.id),className:"text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("svg",{className:"w-5 h-5 inline",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})}),i.open&&i.bloque&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 min-w-[320px] max-w-md relative",children:[e.jsx("button",{onClick:()=>r({open:!1,bloque:null}),className:"absolute top-2 right-2 text-gray-500 hover:text-red-500 text-xl font-bold","aria-label":"Cerrar",children:"×"}),e.jsx("div",{className:"font-semibold mb-2 text-blue-700",children:"Editar bloque de disponibilidad"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("label",{className:"text-sm",children:["Fecha: ",e.jsx("span",{className:"font-bold",children:i.bloque.fecha})]}),e.jsxs("label",{className:"text-sm",children:["Hora inicio:",e.jsx("input",{type:"time",value:i.bloque.hora_inicio.slice(0,5),onChange:b=>f("hora_inicio",b.target.value+":00"),className:"border rounded px-2 py-1 ml-2",step:"1800"})]}),e.jsxs("label",{className:"text-sm",children:["Hora fin:",e.jsx("input",{type:"time",value:i.bloque.hora_fin.slice(0,5),onChange:b=>f("hora_fin",b.target.value+":00"),className:"border rounded px-2 py-1 ml-2",step:"1800"})]})]}),e.jsx("button",{onClick:v,className:"bg-blue-600 text-white px-4 py-2 rounded font-bold w-full mt-4",children:"Guardar cambios"})]})})]},c.id))})]})]},a)})})]})]})]})}function $(){return e.jsx(H,{})}export{$ as default};
