import{r as o,b as E,j as e,e as C,w as q,E as G,d as K}from"./vendor-B5yQt2qK.js";import{B as N}from"./examenes-laboratorio-crud-BJk1fG4Z.js";function ee(){const $=o.useMemo(()=>{const s=new Date;return new Date(s.getTime()-s.getTimezoneOffset()*6e4).toISOString().slice(0,10)},[]),[r,F]=o.useState($),[d,A]=o.useState($),[p,L]=o.useState(""),[h,T]=o.useState(""),[u,U]=o.useState(""),[b,z]=o.useState(""),[g,I]=o.useState(""),[j,O]=o.useState(""),[R,M]=o.useState(!1),[k,H]=o.useState([]),[f,J]=o.useState(0),[v,_]=o.useState(1),[m,B]=o.useState(3),[V,W]=o.useState([]),[n,w]=o.useState(null),P=E.useCallback(async()=>{const s=()=>{const a=new URLSearchParams;return r&&a.set("desde",r),d&&a.set("hasta",d),p&&a.set("servicio_tipo",p),h&&a.set("usuario_id",h),u&&a.set("cobro_id",u),b&&a.set("paciente",b),g!==""&&a.set("monto_min",g),j!==""&&a.set("monto_max",j),a};let c=1,y=0,t=[];{const a=s();a.set("limit",String(10)),a.set("page",String(c));const x=await(await fetch(`${N}api_log_eliminaciones.php?${a.toString()}`,{credentials:"include"})).json();if(!x.success)return[];y=x.total||0,t=(x.logs||[]).slice()}const i=Math.max(1,Math.ceil(y/10));for(;c<i;){c+=1;const a=s();a.set("limit",String(10)),a.set("page",String(c));const x=await(await fetch(`${N}api_log_eliminaciones.php?${a.toString()}`,{credentials:"include"})).json();if(!x.success)break;Array.isArray(x.logs)&&(t=t.concat(x.logs))}return t},[N,r,d,p,h,u,b,g,j]),D=E.useCallback(async()=>{M(!0);try{const s=new URLSearchParams;r&&s.set("desde",r),d&&s.set("hasta",d),p&&s.set("servicio_tipo",p),h&&s.set("usuario_id",h),u&&s.set("cobro_id",u),b&&s.set("paciente",b),g!==""&&s.set("monto_min",g),j!==""&&s.set("monto_max",j),s.set("limit",String(m)),s.set("page",String(v));const c=await(await fetch(`${N}api_log_eliminaciones.php?${s.toString()}`,{credentials:"include"})).json();c.success&&(H(c.logs||[]),J(c.total||0))}catch{}finally{M(!1)}},[r,d,p,h,u,b,g,j,v,m]);o.useEffect(()=>{D()},[D]),o.useEffect(()=>{(async()=>{try{const l=await(await fetch(`${N}api_usuarios.php`,{credentials:"include"})).json();Array.isArray(l)&&W(l)}catch{}})()},[]);const X=async()=>{const l=(await P()).map(t=>{const i=t.item?.descripcion||t.item?.nombre||JSON.stringify(t.item||{}),a=t.paciente_nombre?`${t.paciente_nombre}${t.paciente_dni?` (${t.paciente_dni})`:""}`:t.paciente_id||"-";return{"Fecha/Hora":new Date(t.fecha_hora.replace(" ","T")).toLocaleString(),Cobro:`#${t.cobro_id}`,Servicio:t.servicio_tipo,Descripción:i,Monto:Number(t.monto),Motivo:t.motivo||"",Usuario:t.usuario_nombre||t.usuario_id||"",Paciente:a,Caja:t.caja_id||""}}),c=C.json_to_sheet(l),y=C.book_new();C.book_append_sheet(y,c,"Auditoria"),q(y,`auditoria_eliminaciones_${r}_a_${d}.xlsx`)},Y=async()=>{const s=await P(),l=new G({orientation:"landscape"}),c=`Auditoría de Eliminaciones ${r} a ${d}`;l.setFontSize(14),l.text(c,14,16);const y=[["Fecha/Hora","Cobro","Servicio","Descripción","Monto","Motivo","Usuario","Paciente","Caja"]],t=s.map(i=>{const a=i.item?.descripcion||i.item?.nombre||JSON.stringify(i.item||{}),S=String(a),x=i.paciente_nombre?`${i.paciente_nombre}${i.paciente_dni?` (${i.paciente_dni})`:""}`:i.paciente_id||"-";return[new Date(i.fecha_hora.replace(" ","T")).toLocaleString(),`#${i.cobro_id}`,i.servicio_tipo,S,`S/ ${Number(i.monto).toFixed(2)}`,i.motivo||"-",i.usuario_nombre||i.usuario_id||"-",x,i.caja_id||"-"]});K(l,{head:y,body:t,styles:{fontSize:8,cellPadding:2},headStyles:{fillColor:[231,229,228],textColor:20},columnStyles:{4:{halign:"right"}},startY:20,margin:{left:10,right:10},tableWidth:"auto"}),l.save(`auditoria_eliminaciones_${r}_a_${d}.pdf`)};return e.jsxs("div",{className:"max-w-[1400px] mx-auto p-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-rose-700 mb-4 text-center",children:"Auditoría de Eliminaciones"}),e.jsx("div",{className:"bg-white rounded-xl shadow p-4 mb-4",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Desde"}),e.jsx("input",{type:"date",value:r,onChange:s=>F(s.target.value),className:"w-full border rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Hasta"}),e.jsx("input",{type:"date",value:d,onChange:s=>A(s.target.value),className:"w-full border rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Servicio"}),e.jsxs("select",{value:p,onChange:s=>L(s.target.value),className:"w-full border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"farmacia",children:"Farmacia"}),e.jsx("option",{value:"laboratorio",children:"Laboratorio"}),e.jsx("option",{value:"consulta",children:"Consulta"}),e.jsx("option",{value:"ecografia",children:"Ecografía"}),e.jsx("option",{value:"rayosx",children:"Rayos X"}),e.jsx("option",{value:"procedimiento",children:"Procedimiento"}),e.jsx("option",{value:"operaciones",children:"Operaciones"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Paciente (nombre/DNI)"}),e.jsx("input",{type:"text",value:b,onChange:s=>z(s.target.value),className:"w-full border rounded px-2 py-1",placeholder:"Ej. Pérez 44556677"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Usuario"}),e.jsxs("select",{value:h,onChange:s=>T(s.target.value),className:"w-full border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"Todos"}),V.map(s=>e.jsxs("option",{value:s.id,children:[s.nombre," (",s.usuario,")"]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Cobro ID"}),e.jsx("input",{type:"number",min:"1",value:u,onChange:s=>U(s.target.value),className:"w-full border rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Monto mínimo"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:g,onChange:s=>I(s.target.value),className:"w-full border rounded px-2 py-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"Monto máximo"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:j,onChange:s=>O(s.target.value),className:"w-full border rounded px-2 py-1"})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{onClick:()=>_(1),className:"w-full bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-2 rounded shadow",children:"Filtrar"}),e.jsx("button",{onClick:X,className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded shadow",children:"Exportar Excel"}),e.jsx("button",{onClick:Y,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded shadow",children:"Exportar PDF"})]})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 text-gray-700",children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Fecha/Hora"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Cobro"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Servicio"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Descripción"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Monto"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Motivo"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Usuario"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Paciente"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Caja"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Acciones"})]})}),e.jsx("tbody",{children:R?e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4",colSpan:10,children:"Cargando..."})}):k.length===0?e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4",colSpan:10,children:"Sin resultados"})}):k.map(s=>{const l=s.item?.descripcion||s.item?.nombre||JSON.stringify(s.item);return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-3 py-2",children:new Date(s.fecha_hora.replace(" ","T")).toLocaleString()}),e.jsxs("td",{className:"px-3 py-2",children:["#",s.cobro_id]}),e.jsx("td",{className:"px-3 py-2 capitalize",children:s.servicio_tipo}),e.jsx("td",{className:"px-3 py-2",children:l}),e.jsxs("td",{className:"px-3 py-2 text-right",children:["S/ ",Number(s.monto).toFixed(2)]}),e.jsx("td",{className:"px-3 py-2",children:s.motivo||"-"}),e.jsx("td",{className:"px-3 py-2",children:s.usuario_nombre||s.usuario_id||"-"}),e.jsx("td",{className:"px-3 py-2",children:s.paciente_nombre?`${s.paciente_nombre}${s.paciente_dni?` (${s.paciente_dni})`:""}`:s.paciente_id||"-"}),e.jsx("td",{className:"px-3 py-2",children:s.caja_id||"-"}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("button",{onClick:()=>w(s),className:"text-rose-700 hover:text-rose-900 font-semibold text-sm",children:"Ver detalle"})})]},s.id)})})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow mt-3 p-3 flex flex-col sm:flex-row items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Por página:"}),e.jsxs("select",{className:"border rounded px-2 py-1",value:m,onChange:s=>{B(Number(s.target.value)),_(1)},children:[e.jsx("option",{value:3,children:"3"}),e.jsx("option",{value:5,children:"5"}),e.jsx("option",{value:10,children:"10"})]})]}),e.jsx("div",{className:"text-sm text-gray-600",children:f>0?`${Math.min((v-1)*m+1,f)}–${Math.min(v*m,f)} de ${f}`:"0 resultados"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded disabled:opacity-50",onClick:()=>_(s=>Math.max(1,s-1)),disabled:v<=1,children:"Anterior"}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Página ",v," / ",Math.max(1,Math.ceil(f/m))]}),e.jsx("button",{className:"px-3 py-1 border rounded disabled:opacity-50",onClick:()=>_(s=>Math.min(Math.max(1,Math.ceil(f/m)),s+1)),disabled:v>=Math.max(1,Math.ceil(f/m)),children:"Siguiente"})]})]}),n&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg max-w-3xl w-full p-4 relative",children:[e.jsx("button",{className:"absolute right-3 top-2 text-gray-500 hover:text-red-600 text-xl font-bold",onClick:()=>w(null),children:"×"}),e.jsx("h3",{className:"text-lg font-bold text-rose-700 mb-2",children:"Detalle de Eliminación"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Fecha:"})," ",new Date(n.fecha_hora.replace(" ","T")).toLocaleString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Cobro:"})," #",n.cobro_id]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Servicio:"})," ",n.servicio_tipo]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Monto:"})," S/ ",Number(n.monto).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Usuario:"})," ",n.usuario_nombre?`${n.usuario_nombre} (${n.usuario_id})`:n.usuario_id||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Paciente:"})," ",n.paciente_nombre||n.paciente_id," ",n.paciente_dni?`(${n.paciente_dni})`:""]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Caja ID:"})," ",n.caja_id||"-"]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("span",{className:"font-semibold",children:"Motivo:"})," ",n.motivo||"-"]})]}),e.jsx("pre",{className:"bg-gray-100 rounded p-3 overflow-auto text-xs max-h-80",children:JSON.stringify(n.item,null,2)}),e.jsx("div",{className:"mt-3 text-right",children:e.jsx("button",{className:"bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-2 rounded",onClick:()=>w(null),children:"Cerrar"})})]})})]})}export{ee as default};
