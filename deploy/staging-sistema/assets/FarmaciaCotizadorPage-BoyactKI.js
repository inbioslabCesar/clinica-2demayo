import{r as f,u as _e,k as Ce,t as we,j as r,G as Ee,H as ke,S}from"./vendor-B5yQt2qK.js";import{C as Me}from"./CobroModuloFinal-Vv0lAaBv.js";import{P as Pe}from"./PacienteListSearch-BKe_T2Or.js";import{B as P}from"./examenes-laboratorio-crud-BJk1fG4Z.js";function ze(){const pe=()=>{if(E.length===0){T("Selecciona al menos un medicamento.");return}if(!N||!N.nombre||!N.dni||!N.historia_clinica){T("Debes seleccionar o crear un paciente antes de registrar la venta.");return}const e=E.map(a=>{const i=_.find(d=>String(d.id)===String(a));if(!i)return null;const s=C[a]||"unidad",o=k[a]||30,c=Number(i.stock||0),g=Math.floor(c/o);let t=Number(v[a]??0);if(s==="caja"?t=Math.min(t,g):t=Math.min(t,c),t<=0)return null;const n=L(i);let l=0,m=i&&i.nombre&&i.nombre!=="0"?i.nombre:"Medicamento sin nombre";return s==="caja"?(l=n*o*t,m+=" (Caja)"):(l=n*t,m+=" (Unidad)"),{servicio_tipo:"farmacia",servicio_id:Number(a),descripcion:m,cantidad:t,precio_unitario:n,subtotal:l}}).filter(Boolean);if(e.length===0){T("No hay cantidades v√°lidas para cotizar. Verifica el stock disponible.");return}he(e),X(Q()),W(!0)},[re,W]=f.useState(!1),[be,he]=f.useState([]),[fe,X]=f.useState(0),R=_e(),x=Ce(),q=we(),[ie,Y]=f.useState(!1),[ne,Z]=f.useState(!1),[_,ge]=f.useState([]),[J,xe]=f.useState(""),[E,A]=f.useState([]),[v,U]=f.useState({}),[C,I]=f.useState({}),[k,je]=f.useState({}),M=q.pacienteId||null,[N,G]=f.useState(null),ee=!!new URLSearchParams(x.search).get("cobro_id"),[H,se]=f.useState(""),[oe,ce]=f.useState(""),[de,le]=f.useState(""),[ae,T]=f.useState(""),[te,V]=f.useState({}),[F,K]=f.useState([]),[O,B]=f.useState(null);f.useEffect(()=>{fetch(`${P}api_medicamentos.php`,{credentials:"include"}).then(e=>e.json()).then(e=>{ge(e.medicamentos||e||[]);const a={};(e.medicamentos||e||[]).forEach(i=>{a[i.id]=i.unidades_por_caja||30}),je(a)})},[]),f.useEffect(()=>{fetch(`${P}api_caja_estado.php`,{credentials:"include"}).then(e=>e.json()).then(e=>{e&&e.success?B(e.estado||"cerrada"):B("cerrada")}).catch(()=>B("cerrada"))},[]),f.useEffect(()=>{M&&fetch(`${P}api_pacientes.php?id=${M}`).then(e=>e.json()).then(e=>{e.success&&e.paciente&&G({id:e.paciente.id,dni:e.paciente.dni,nombre:(e.paciente.nombres||e.paciente.nombre||"")+" "+(e.paciente.apellidos||e.paciente.apellido||""),historia_clinica:e.paciente.historia_clinica||""})})},[M]),f.useEffect(()=>{const e=new URLSearchParams(x.search),a=e.get("cobro_id"),i=e.get("cotizacion_id"),s=[];a&&s.push(fetch(`${P}api_cobros.php?cobro_id=${a}`,{credentials:"include"}).then(o=>o.json()).then(o=>{const c=o.cobro||o?.result?.cobro||null;if(!o.success||!c)return;const g=Array.isArray(c.detalles)?c.detalles:[],t=[];if(g.forEach(n=>{if((n.servicio_tipo||"").toLowerCase()==="farmacia")try{const l=JSON.parse(n.descripcion);Array.isArray(l)&&t.push(...l)}catch{}}),t.length){K(t);const n=Array.from(new Set(t.map(d=>String(d.servicio_id)).filter(Boolean)));A(n);const l={},u={},m={};t.forEach(d=>{const p=String(d.servicio_id),h=(d.descripcion||"").toLowerCase().includes("(caja)")?"caja":"unidad";l[p]=(l[p]||0)+Number(d.cantidad||1),u[p]=h,m[p]||(m[p]={unidad:0,caja:0}),m[p][h]+=Number(d.cantidad||1)}),U(d=>({...d,...l})),I(d=>({...d,...u})),V(m)}})),i&&s.push(fetch(`${P}api_cotizaciones.php?cotizacion_id=${i}`,{credentials:"include"}).then(o=>o.json()).then(o=>{const c=o.cotizacion||null;if(!o.success||!c)return;const t=(Array.isArray(c.detalles)?c.detalles:[]).filter(n=>(n.servicio_tipo||"").toLowerCase()==="farmacia");if(t.length){K(t);const n=Array.from(new Set(t.map(d=>String(d.servicio_id)).filter(Boolean)));A(n);const l={},u={},m={};t.forEach(d=>{const p=String(d.servicio_id),h=(d.descripcion||"").toLowerCase().includes("(caja)")?"caja":"unidad";l[p]=(l[p]||0)+Number(d.cantidad||1),u[p]=h,m[p]||(m[p]={unidad:0,caja:0}),m[p][h]+=Number(d.cantidad||1)}),U(d=>({...d,...l})),I(d=>({...d,...u})),V(m)}})),s.length&&Promise.all(s).catch(()=>{})},[x.search]);const L=e=>{if(!e)return 0;const a=Number(e.precio_compra||0),i=Number(e.margen_ganancia||0);return a+a*i/100},ue=_.filter(e=>e.nombre.toLowerCase().includes(J.toLowerCase())||e.codigo&&e.codigo.toLowerCase().includes(J.toLowerCase())),Ne=e=>{const a=String(e),i=_.find(n=>String(n.id)===a),s=k[a]||30,o=Number(i?.stock||0),c=Math.floor(o/s);if(o<=0&&c<=0){S.fire("Sin stock","Este medicamento no tiene stock disponible.","info");return}const g=o>0?"unidad":"caja",t=1;A(n=>n.includes(a)?n:[...n,a]),U(n=>({...n,[a]:t})),I(n=>({...n,[a]:g}))},ye=async e=>{const a=String(e),i=new URLSearchParams(x.search).get("cobro_id"),s=C[a]||"unidad";if(i){const o=Number(v[a]??0);if(o<=0)return;const c=await S.fire({title:"Eliminar del cobro",text:"Esta acci√≥n quitar√° el producto del cobro y repondr√° stock. ¬øContinuar?",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",input:"text",inputLabel:"Motivo de la eliminaci√≥n",inputPlaceholder:"Ej. duplicado, error de registro, ajuste",inputValidator:d=>{if(!d||d.trim().length<4)return"Ingresa un motivo (m√≠nimo 4 caracteres)"}});if(!c.isConfirmed)return;const g=(c.value||"").trim();try{const d=await fetch(`${P}api_caja_estado.php`,{credentials:"include"}).then(p=>p.json());if(!d?.success||d?.estado!=="abierta"){B(d?.estado||"cerrada"),S.fire("Caja cerrada","Abre caja para poder eliminar √≠tems del cobro.","error");return}B("abierta")}catch{S.fire("Error","No se pudo verificar el estado de la caja.","error");return}const t=o,n=_.find(d=>String(d.id)===String(a)),l=k[a]||30,u=L(n),m=`${n?.nombre||"Medicamento"} (${s==="caja"?"Caja":"Unidad"})`;try{const p=await(await fetch(`${P}api_cobro_eliminar_item.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(i),servicio_tipo:"farmacia",motivo:g,item:{servicio_id:Number(a),descripcion:m,cantidad_eliminar:t,precio_unitario:u,subtotal:s==="caja"?u*l*t:u*t}})})).json();if(!p.success){S.fire("Error",p.error||"No se pudo eliminar","error");return}V(b=>{const h={...b},w=h[a]||{unidad:0,caja:0};return s==="caja"?w.caja=Math.max(0,Number(w.caja||0)-t):w.unidad=Math.max(0,Number(w.unidad||0)-t),h[a]=w,h}),K(b=>Array.isArray(b)?b:[]),A(b=>b.filter(h=>h!==a)),U(b=>{const h={...b};return delete h[a],h}),I(b=>{const h={...b};return delete h[a],h}),S.fire("Eliminado","√çtem eliminado y stock repuesto.","success").then(()=>{const b=M||N&&N.id;R(b?`/consumo-paciente/${b}`:"/pacientes")})}catch{S.fire("Error","Fallo de conexi√≥n con el servidor","error")}return}A(o=>o.filter(c=>c!==a)),U(o=>{const c={...o};return delete c[a],c}),I(o=>{const c={...o};return delete c[a],c})},me=(e,a)=>{const i=String(e);U(s=>({...s,[i]:a}))},Se=(e,a)=>{const i=String(e);I(s=>({...s,[i]:a})),a==="caja"&&U(s=>({...s,[i]:1}))},Q=()=>{if(ee){const e={};return Array.isArray(F)&&F.forEach(a=>{const i=(a.descripcion||"").toLowerCase().includes("(caja)")?"caja":"unidad",s=`${a.servicio_id}::${i}`;e[s]||(e[s]={servicio_id:a.servicio_id,tipo:i,subtotal:0}),e[s].subtotal+=Number(a.subtotal||0)}),E.forEach(a=>{const i=C[a]||"unidad",s=k[a]||30,o=_.find(l=>String(l.id)===String(a)),c=L(o),g=Number(v[a]??0),t=i==="caja"?c*s*g:c*g,n=`${a}::${i}`;g>0?e[n]={servicio_id:a,tipo:i,subtotal:t}:e[n]&&delete e[n]}),Object.values(e).reduce((a,i)=>a+Number(i.subtotal||0),0)}return E.reduce((e,a)=>{const i=_.find(n=>String(n.id)===String(a));if(!i)return e;const s=C[a]||"unidad",o=k[a]||30,c=Number(i.stock||0),g=Math.floor(c/o);let t=Number(v[a]??0);return s==="caja"?t=Math.min(t,g):t=Math.min(t,c),t<=0?e:s==="caja"?e+L(i)*o*t:e+L(i)*t},0)};f.useEffect(()=>{X(Q())},[E,v,C,F,_,k,ee]);const ve=async()=>{const e=new URLSearchParams(x.search).get("cobro_id");if(!e)return;try{const t=await fetch(`${P}api_caja_estado.php`,{credentials:"include"}).then(n=>n.json());if(!t?.success||t?.estado!=="abierta"){B(t?.estado||"cerrada"),S.fire("Error","No hay caja abierta. Abre caja para actualizar este cobro.","error");return}B("abierta")}catch{S.fire("Error","No se pudo verificar el estado de la caja.","error");return}const a=[],i=[];if(Array.from(new Set([...E||[],...Object.keys(te||{})])).forEach(t=>{const n=te[t]||{unidad:0,caja:0},l=_.find($=>String($.id)===String(t)),u=k[t]||30;let m=C[t];m||(m=n.caja&&Number(n.caja)>0?"caja":"unidad");const d=Object.prototype.hasOwnProperty.call(v,t),p=d?Number(v[t]??0):null,b=p===null?Number(m==="caja"?n.caja||0:n.unidad||0):p,h=m==="unidad"?b:0,w=m==="caja"?b:0,z=Number(h)-Number(n.unidad||0),j=Number(w)-Number(n.caja||0),y=L(l),D=l&&l.nombre&&l.nombre!=="0"?l.nombre:"Medicamento";if(z>0)a.push({servicio_id:t,descripcion:`${D} (Unidad)`,cantidad:z,precio_unitario:y,subtotal:y*z});else if(z<0&&d){const $=Math.abs(z);i.push({servicio_id:t,tipo:"unidad",cantidad_eliminar:$,descripcion:`${D} (Unidad)`,precio_unitario:y,subtotal:y*$})}if(j>0)a.push({servicio_id:t,descripcion:`${D} (Caja)`,cantidad:j,precio_unitario:y,subtotal:y*u*j});else if(j<0&&d){const $=Math.abs(j);i.push({servicio_id:t,tipo:"caja",cantidad_eliminar:$,descripcion:`${D} (Caja)`,precio_unitario:y,subtotal:y*u*$})}}),console.debug("ActualizarCobro diffs",{itemsAgregar:a,itemsEliminar:i,preloadedFarmacia:te,cantidades:v,tiposVenta:C}),a.length===0&&i.length===0){S.fire("Sin cambios","No hay cambios para aplicar.","info");return}let o="";if(i.length>0){const t=await S.fire({title:"Confirmar reducci√≥n/eliminaci√≥n",text:"Se reducir√° la cantidad (o se eliminar√°n √≠tems) del cobro y se repondr√° stock. ¬øContinuar?",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",input:"text",inputLabel:"Motivo del ajuste",inputPlaceholder:"Ej. ajuste por cambio de receta, error, devoluci√≥n",inputValidator:n=>{if(!n||n.trim().length<4)return"Ingresa un motivo (m√≠nimo 4 caracteres)"}});if(!t.isConfirmed)return;o=(t.value||"").trim()}for(const t of i)try{const l=await(await fetch(`${P}api_cobro_eliminar_item.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(e),servicio_tipo:"farmacia",motivo:o,item:{servicio_id:Number(t.servicio_id),descripcion:t.descripcion,cantidad_eliminar:Number(t.cantidad_eliminar),precio_unitario:Number(t.precio_unitario||0),subtotal:Number(t.subtotal||0)}})})).json();if(!l.success){S.fire("Error",l.error||"No se pudo aplicar la reducci√≥n","error");return}}catch{S.fire("Error","Fallo de conexi√≥n con el servidor","error");return}if(a.length>0)try{const n=await(await fetch(`${P}api_cobro_actualizar.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(e),servicio_tipo:"farmacia",items:a})})).json();if(!n.success){S.fire("Error",n.error||"No se pudo actualizar el cobro","error");return}}catch{S.fire("Error","Fallo de conexi√≥n con el servidor","error");return}const c={},g=!!new URLSearchParams(x.search).get("cobro_id");E.forEach(t=>{const n=C[t]||"unidad",l=k[t]||30,u=_.find(h=>String(h.id)===String(t)),m=Number(u?.stock||0),d=Math.floor(m/l),p=Number(v[t]??0);let b;g?b=p:b=n==="caja"?Math.min(p,d):Math.min(p,m),c[String(t)]={unidad:n==="unidad"?b:0,caja:n==="caja"?b:0}}),V(c),S.fire("Actualizado",`Cambios aplicados. Agregados: ${a.length}, reducidos/eliminados: ${i.length}.`,"success").then(async()=>{try{const n=new URLSearchParams(x.search).get("cobro_id");if(!n)return;const u=await(await fetch(`${P}api_cobros.php?cobro_id=${n}`,{credentials:"include"})).json();if(!u||!u.success||!u.cobro)return;const m=Array.isArray(u.cobro.detalles)?u.cobro.detalles:[],d=[];m.forEach(j=>{if((j.servicio_tipo||"").toLowerCase()==="farmacia")try{const y=JSON.parse(j.descripcion);Array.isArray(y)&&d.push(...y)}catch{}}),K(d);const p=Array.from(new Set(d.map(j=>String(j.servicio_id)).filter(Boolean)));A(p);const b={},h={},w={};d.forEach(j=>{const y=String(j.servicio_id),$=(j.descripcion||"").toLowerCase().includes("(caja)")?"caja":"unidad";b[y]=(b[y]||0)+Number(j.cantidad||1),h[y]=$,w[y]||(w[y]={unidad:0,caja:0}),w[y][$]+=Number(j.cantidad||1)}),U(j=>({...j,...b})),I(j=>({...j,...h})),V(w),X(Q());const z=u.cobro?.paciente_id||M||N&&N.id;if(z){R(`/consumo-paciente/${z}`);return}}catch(t){console.error("Error refrescando cobro despu√©s de actualizar:",t)}})};return r.jsxs("div",{className:"w-full mx-auto px-4 sm:px-8 lg:px-12 xl:px-24 2xl:px-40 py-6 bg-white rounded-2xl shadow-2xl mt-8 border border-blue-100",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsxs("h2",{className:"text-3xl font-bold text-blue-900 flex items-center gap-2",children:[r.jsx("span",{role:"img","aria-label":"medicamentos",children:"üíä"}),"Cotizador de Medicamentos",(new URLSearchParams(x.search).get("cobro_id")||new URLSearchParams(x.search).get("cotizacion_id"))&&r.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-300",children:new URLSearchParams(x.search).get("cobro_id")?`Editando cobro #${new URLSearchParams(x.search).get("cobro_id")}`:new URLSearchParams(x.search).get("cotizacion_id")?`Editando cotizaci√≥n #${new URLSearchParams(x.search).get("cotizacion_id")}`:"Editando"})]}),M&&!(new URLSearchParams(x.search).get("cobro_id")||new URLSearchParams(x.search).get("cotizacion_id"))?r.jsx("button",{className:"bg-blue-100 text-blue-800 px-4 py-2 rounded font-semibold border border-blue-300 hover:bg-blue-200 transition",onClick:()=>R("/seleccionar-servicio",{state:{pacienteId:M}}),children:"‚Üê Volver a Servicios"}):r.jsx("button",{className:"bg-purple-100 text-purple-800 px-4 py-2 rounded font-semibold border border-purple-300 hover:bg-purple-200 transition",onClick:()=>{const e=new URLSearchParams(x.search),a=!!(e.get("cobro_id")||e.get("cotizacion_id")),i=M||N?.id;R(a?i?`/consumo-paciente/${i}`:"/pacientes":"/medicamentos")},children:(()=>{const e=new URLSearchParams(x.search);return!!(e.get("cobro_id")||e.get("cotizacion_id"))?"‚Üê Volver a Consumo del Paciente":"‚Üê Ir a Lista de Medicamentos"})()})]}),r.jsxs("div",{className:"mb-4",children:[!q.pacienteId&&r.jsx(Pe,{onPacienteEncontrado:e=>{G({id:e.id,dni:e.dni||"",nombre:((e.nombre||"")+" "+(e.apellido||"")).trim(),historia_clinica:e.historia_clinica||""}),se(""),ce(""),le(""),Z(!0),T("")},onNoEncontrado:()=>{G(null),Y(!0),Z(!0),T("Paciente no encontrado. Verifica el DNI, nombre o historia cl√≠nica.")},onNuevaBusqueda:()=>{G(null),Y(!1),Z(!1)}}),!q.pacienteId&&!M&&!H&&!ie&&ne&&!N&&r.jsx("button",{className:"mt-2 px-3 py-1 bg-yellow-100 text-yellow-800 rounded border border-yellow-300 text-sm",onClick:()=>Y(!0),children:"Paciente no encontrado"}),!q.pacienteId&&ie&&!M&&r.jsxs("div",{className:"flex gap-2 items-center mt-2",children:[r.jsx("input",{type:"text",value:H,onChange:e=>se(e.target.value),placeholder:"DNI",className:"border px-2 py-1 rounded w-32"}),r.jsx("input",{type:"text",value:oe,onChange:e=>ce(e.target.value),placeholder:"Nombres",className:"border px-2 py-1 rounded w-40",required:!0}),r.jsx("input",{type:"text",value:de,onChange:e=>le(e.target.value),placeholder:"Apellidos",className:"border px-2 py-1 rounded w-40",required:!0})]}),(M||H)&&r.jsxs("div",{className:"mt-2 p-2 bg-blue-50 rounded text-blue-800 text-sm",children:[r.jsx("span",{className:"font-bold",children:"Paciente:"})," ",N?`${N.nombre} (DNI: ${N.dni})`:`${oe} ${de} (DNI: ${H})`]})]}),r.jsxs("div",{className:"mb-4 flex gap-2 items-center",children:[r.jsx("span",{className:"text-blue-700 text-xl",children:"üîç"}),r.jsx("input",{type:"text",value:J,onChange:e=>xe(e.target.value),placeholder:"Buscar medicamento...",className:"border px-3 py-2 rounded-lg w-full max-w-md focus:ring-2 focus:ring-blue-300"})]}),r.jsx("div",{className:"mb-4",children:r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsx("div",{className:"col-span-1",children:_.length===0?r.jsx("div",{className:"text-center text-gray-500 py-8",children:"No hay medicamentos registrados en el sistema."}):ue.length===0?r.jsxs("div",{className:"text-center text-gray-500 py-8",children:['Sin coincidencias para "',J,'".']}):r.jsx("div",{className:"max-h-96 overflow-y-auto",children:r.jsx("ul",{className:"divide-y divide-gray-100",children:ue.map(e=>{const a=k[e.id]||30,i=Number(e.stock||0),s=Math.floor(i/a),o=i<=0,c=s<=0,g=o&&c;return r.jsxs("li",{className:"flex items-center gap-4 py-3 px-2 hover:bg-blue-50 rounded-lg transition-all",children:[r.jsxs("div",{className:"flex-1",children:[r.jsxs("div",{className:"font-semibold text-gray-800 flex items-center gap-2",children:[r.jsx("span",{className:"text-blue-600",children:"üß™"}),e.nombre]}),r.jsxs("div",{className:"text-xs text-gray-500 flex gap-2 items-center",children:[r.jsxs("span",{children:["üì¶ ",s," cajas"]}),r.jsxs("span",{children:["üíä ",i," unidades"]}),r.jsxs("span",{children:["üí≤ S/ ",L(e).toFixed(2)," / unidad"]})]})]}),E.includes(String(e.id))?r.jsxs(r.Fragment,{children:[r.jsxs("select",{value:C[String(e.id)]||"unidad",onChange:t=>Se(String(e.id),t.target.value),className:"border rounded-lg px-2 py-1 mr-2 bg-white",children:[r.jsx("option",{value:"unidad",disabled:o,children:"Unidad"}),r.jsx("option",{value:"caja",disabled:c,children:"Caja"})]}),C[String(e.id)]==="caja"?r.jsx("input",{type:"number",min:c?0:1,max:c?0:s,disabled:c,value:c?0:v[String(e.id)]||1,onChange:t=>me(String(e.id),Math.max(0,Math.min(s,Number(t.target.value)))),className:"border rounded-lg px-2 w-16 bg-white"}):r.jsx("input",{type:"number",min:o?0:1,max:o?0:i,disabled:o,value:o?0:v[String(e.id)]||1,onChange:t=>me(String(e.id),Math.max(0,Math.min(i,Number(t.target.value)))),className:"border rounded-lg px-2 w-16 bg-white"}),r.jsx("button",{onClick:()=>ye(String(e.id)),className:"ml-2 w-10 h-10 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-700 text-xl shadow transition","aria-label":"Quitar",children:r.jsx(Ee,{})})]}):g?r.jsx("button",{disabled:!0,className:"w-24 h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 text-sm shadow cursor-not-allowed",title:"Sin stock",children:"Sin stock"}):r.jsx("button",{onClick:()=>Ne(String(e.id)),className:"w-10 h-10 flex items-center justify-center rounded-full bg-green-100 hover:bg-green-200 text-green-700 text-xl shadow transition","aria-label":"Agregar",children:r.jsx(ke,{})})]},e.id)})})})}),r.jsxs("div",{className:"col-span-1 md:sticky md:top-24 md:ml-8 w-full md:w-[28rem] lg:w-[32rem] xl:w-[36rem]",children:[E.length>0&&!re&&r.jsxs("div",{className:"mb-6",children:[r.jsx("h4",{className:"font-semibold text-gray-700 mb-2",children:"Lista de Cotizaci√≥n"}),r.jsx("ul",{className:"divide-y divide-gray-200 bg-gray-50 rounded-lg shadow p-4 max-h-80 overflow-y-auto",children:(()=>{if(ee&&Array.isArray(F)&&F.length>0){const e={};return F.forEach(a=>{const i=(a.descripcion||"").toLowerCase().includes("(caja)")?"caja":"unidad",s=`${a.servicio_id}::${i}`;e[s]||(e[s]={servicio_id:a.servicio_id,descripcion:a.descripcion,cantidad:0,subtotal:0,tipo:i}),e[s].cantidad+=Number(a.cantidad??1),e[s].subtotal+=Number(a.subtotal??0)}),E.forEach(a=>{const i=C[a]||"unidad",s=Number(v[a]??0),o=_.find(l=>String(l.id)===String(a)),c=k[a]||30,g=L(o),t=i==="caja"?g*c*s:g*s,n=Object.keys(e).find(l=>String(e[l].servicio_id)===String(a)&&e[l].tipo===i);if(n)e[n].cantidad=s,e[n].subtotal=t;else if(s>0){const l=(o?.nombre||"Medicamento")+(i==="caja"?" (Caja)":" (Unidad)"),u=`${a}::${i}`;e[u]={servicio_id:a,descripcion:l,cantidad:s,subtotal:t,tipo:i}}}),Object.values(e).map((a,i)=>r.jsxs("li",{className:"py-2 flex justify-between items-center",children:[r.jsxs("span",{className:"flex items-center gap-1",children:[r.jsx("span",{children:"üíä"}),a.descripcion]}),r.jsxs("span",{children:[a.cantidad," ",a.tipo==="caja"?"caja(s)":"unidad(es)"]}),r.jsxs("span",{className:"font-bold text-green-700",children:["S/ ",Number(a.subtotal||0).toFixed(2)]})]},i))}return E.map(e=>{const a=_.find(m=>String(m.id)===String(e)),i=C[e]||"unidad",s=Number(v[e]??0),o=k[e]||30,c=Number(a?.stock||0),g=Math.floor(c/o),t=i==="caja"?Math.min(s,g):Math.min(s,c),n=L(a);let l=0,u=a?.nombre||"";return i==="caja"?(l=n*o*t,u+=" (Caja)"):(l=n*t,u+=" (Unidad)"),r.jsxs("li",{className:"py-2 flex justify-between items-center",children:[r.jsxs("span",{className:"flex items-center gap-1",children:[r.jsx("span",{children:"üíä"}),u]}),r.jsxs("span",{children:[t," ",i==="caja"?"caja(s)":"unidad(es)"]}),r.jsxs("span",{className:"font-bold text-green-700",children:["S/ ",l.toFixed(2)]})]},e)})})()}),r.jsxs("div",{className:"mt-4 text-lg font-bold text-right",children:["Total: ",r.jsxs("span",{className:"text-green-600",children:["S/ ",Q().toFixed(2)]})]}),r.jsxs("div",{className:"flex gap-3 mt-4 justify-end",children:[r.jsx("button",{onClick:()=>{A([]),T("")},className:"bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200",children:"Limpiar selecci√≥n"}),new URLSearchParams(x.search).get("cobro_id")?r.jsx("button",{onClick:ve,disabled:O==="cerrada",className:`px-6 py-2 rounded font-bold ${O==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:"Actualizar cobro"}):r.jsx("button",{onClick:pe,disabled:O==="cerrada",className:`px-6 py-2 rounded font-bold ${O==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:"Registrar Venta"})]}),(new URLSearchParams(x.search).get("cobro_id")||!new URLSearchParams(x.search).get("cobro_id"))&&O==="cerrada"&&r.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[r.jsxs("span",{className:"text-sm text-red-600",children:["Caja cerrada: abre una caja para poder ",new URLSearchParams(x.search).get("cobro_id")?"actualizar":"cobrar","."]}),r.jsx("button",{onClick:()=>R("/contabilidad"),className:"text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded border border-yellow-300 hover:bg-yellow-200",children:"Ir a Contabilidad"})]})]}),re&&(N&&N.nombre&&N.dni&&N.historia_clinica?r.jsx(Me,{paciente:N,servicio:{key:"farmacia",label:"Farmacia"},detalles:be,total:fe,onCobroCompleto:()=>{W(!1),A([]),U({}),T("Venta procesada correctamente.")},onCancelar:()=>W(!1)}):ne?r.jsx("div",{className:"p-4 bg-red-100 text-red-700 rounded-lg font-semibold text-center",children:"Faltan datos completos del paciente (nombre, DNI y historia cl√≠nica). Por favor, ingr√©salos antes de continuar con el cobro."}):null)]})]})}),ae&&r.jsx("div",{className:`mt-4 text-center font-semibold ${ae.includes("registrada")?"text-green-600":"text-red-600"}`,children:ae})]})}export{ze as default};
