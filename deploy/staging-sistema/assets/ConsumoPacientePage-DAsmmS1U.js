import{r,t as K,u as W,j as e,S as p,J as Y,K as L,M as Q}from"./vendor-B5yQt2qK.js";import{B as w}from"./examenes-laboratorio-crud-BJk1fG4Z.js";import{S as X}from"./Spinner-4kDqlTQV.js";function oe(){const[D,N]=r.useState(!1),[a,B]=r.useState(null),[b,S]=r.useState([]),[f,E]=r.useState(""),[g,F]=r.useState(""),{pacienteId:u}=K(),$=W(),[i,P]=r.useState(null),[O,I]=r.useState(!0),[T,k]=r.useState(""),[m,y]=r.useState(1),[h,R]=r.useState(3);r.useEffect(()=>{y(1)},[h]),r.useEffect(()=>{fetch(`${w}api_consumos_paciente.php?paciente_id=${u}`,{credentials:"include"}).then(t=>t.json()).then(t=>{t.success?P(t):k(t.error||"Error al cargar consumo"),I(!1)}).catch(()=>{k("Error de conexi√≥n con el servidor"),I(!1)})},[u]);const z=r.useMemo(()=>Array.isArray(i?.historial)?i.historial:[],[i]);function C(t){return t.split(" ")[0]}const M=r.useMemo(()=>{let t=z;return f&&(t=t.filter(s=>C(s.fecha)>=f)),g&&(t=t.filter(s=>C(s.fecha)<=g)),t},[z,f,g]),_=r.useMemo(()=>{const t={};return M.forEach(s=>{const o=C(s.fecha)+"_"+s.monto+"_"+s.servicio;t[o]||(t[o]={fecha:s.fecha,servicio:s.servicio,montoTotal:0,detalles:[]}),t[o].detalles.push(s),t[o].montoTotal+=Number(s.monto)}),Object.values(t)},[M]);if(O)return e.jsx(X,{});if(T)return e.jsx("div",{className:"text-red-600 font-bold p-6",children:T});const U=_.length,j=Math.max(1,Math.ceil(U/h)),A=(m-1)*h,V=A+h,H=_.slice(A,V);function G(){if(!a||!b)return;const t=new Date(a.fecha).toLocaleString("es-PE"),s=i.apellido?`${i.nombre} ${i.apellido}`:i.nombre,o=a.tipo_pago?a.tipo_pago.toUpperCase():a.detalles&&a.detalles[0]?.tipo_pago?a.detalles[0].tipo_pago.toUpperCase():"EFECTIVO",l=a.cobertura?a.cobertura.toUpperCase():a.detalles&&a.detalles[0]?.cobertura?a.detalles[0].cobertura.toUpperCase():"PARTICULAR",d=`
      <div style="font-family: monospace; width: 320px; margin: 0 auto;">
        <h3 style="text-align: center; margin-bottom: 10px;">üè• CL√çNICA 2 DE MAYO</h3>
        <hr>
        <p><strong>COMPROBANTE DE PAGO #${a.cobro_id||""}</strong></p>
        <p>Fecha: ${t}</p>
        <p>Paciente: ${s}</p>
        <p>DNI: ${i.dni}</p>
        <p>H.C.: ${i.historia_clinica}</p>
        <hr>
        <p><strong>DETALLE:</strong></p>
        ${b.map(n=>`<p>${n.descripcion} x${n.cantidad||1} .... S/ ${(n.subtotal||n.monto).toFixed(2)}</p>`).join("")}
        <hr>
        <p style="font-weight:bold; font-size:17px; color:#008000;">TOTAL: S/ ${b.reduce((n,c)=>n+Number(c.subtotal||c.monto),0).toFixed(2)}</p>
        <p>Tipo de pago: ${o}</p>
        <p>Cobertura: ${l}</p>
        <hr>
        <div style="text-align: center; font-size: 12px;">Gracias por su preferencia<br>Conserve este comprobante</div>
      </div>
    `;p.fire({title:"Ticket de Cobro",html:d,icon:"info",confirmButtonText:"Imprimir",showCancelButton:!0,cancelButtonText:"Cerrar"}).then(n=>{if(n.isConfirmed){const c=window.open("","_blank","width=400,height=600");c.document.write(`<html><head><title>Ticket</title></head><body>${d}</body></html>`),c.document.close(),c.print()}})}function J(){if(!a)return;const t=String(a.servicio||"").toLowerCase(),o={laboratorio:"/cotizar-laboratorio",ecografia:"/cotizar-ecografia",rayosx:"/cotizar-rayosx",rayos_x:"/cotizar-rayosx",procedimiento:"/cotizar-procedimientos",procedimientos:"/cotizar-procedimientos",operacion:"/cotizar-operacion",operaciones:"/cotizar-operacion",farmacia:"/cotizar-farmacia",consulta:"/agendar-consulta"}[t]||"/seleccionar-servicio",l=a.detalles&&a.detalles[0]&&a.detalles[0].cotizacion_id?a.detalles[0].cotizacion_id:null,d=new URLSearchParams;a.cobro_id&&d.set("cobro_id",a.cobro_id),l&&d.set("cotizacion_id",l);const n=o.includes("/cotizar-")?`${o}/${u}?${d.toString()}`:`${o}?${d.toString()}&paciente_id=${u}`;N(!1),$(n)}return e.jsxs("div",{className:"max-w-3xl mx-auto p-6 bg-white rounded-xl shadow-lg mt-8 font-sans",children:[D&&a&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 max-w-lg w-full relative",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-500 hover:text-red-600 text-xl font-bold",onClick:()=>N(!1),children:"√ó"}),e.jsx("h3",{className:"text-lg font-bold mb-2 text-blue-800",children:"Detalle del Cobro"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Fecha:"})," ",a.fecha,e.jsx("br",{})]}),e.jsx("div",{className:"max-h-[50vh] overflow-y-auto rounded mb-4 border",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-blue-100",children:[e.jsx("th",{className:"px-2 py-1 border text-left",children:"Servicio"}),e.jsx("th",{className:"px-2 py-1 border text-left",children:"Descripci√≥n"}),e.jsx("th",{className:"px-2 py-1 border text-right",children:"Monto (S/)"}),e.jsx("th",{className:"px-2 py-1 border text-center",children:"Acci√≥n"})]})}),e.jsx("tbody",{children:b.map((t,s)=>{const o=t.servicio_tipo||a.servicio;return e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1",children:o}),e.jsx("td",{className:"border px-2 py-1",children:t.descripcion&&t.descripcion!=="0"?t.descripcion:e.jsx("span",{className:"italic text-gray-500",children:"Sin detalle"})}),e.jsx("td",{className:"border px-2 py-1 text-right",children:Number(t.subtotal||t.monto).toFixed(2)}),e.jsx("td",{className:"border px-2 py-1 text-center",children:e.jsx("button",{className:"text-red-600 hover:text-red-800 text-xs font-semibold",onClick:async()=>{const l=Number(t.subtotal||t.monto||0),d=await p.fire({title:l>=500?"Eliminar √≠tem de alto impacto":"Eliminar √≠tem",text:o==="farmacia"?"¬øEliminar y reponer stock?":"¬øEliminar este servicio del cobro?",icon:"warning",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",input:"text",inputLabel:"Motivo de la eliminaci√≥n",inputPlaceholder:"Ej. error de registro, duplicado, ajuste",inputValidator:c=>{if(!c||c.trim().length<4)return"Ingresa un motivo (m√≠nimo 4 caracteres)"}});if(!d.isConfirmed)return;const n=(d.value||"").trim();if(!(l>=500&&!(await p.fire({title:"Confirmaci√≥n final",html:`<div style='font-size:1.05em'>Este √≠tem tiene un monto de <b>S/ ${l.toFixed(2)}</b>.<br/>Es una eliminaci√≥n de alto impacto.</div>`,icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar definitivamente",cancelButtonText:"Cancelar",input:"text",inputPlaceholder:"Escribe ELIMINAR para confirmar",inputValidator:v=>{if(v!=="ELIMINAR")return"Debes escribir ELIMINAR"}})).isConfirmed))try{const v=await(await fetch(`${w}api_cobro_eliminar_item.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:a.cobro_id,servicio_tipo:o,motivo:n,item:{servicio_id:t.servicio_id,descripcion:t.descripcion,cantidad:t.cantidad,precio_unitario:t.precio_unitario,subtotal:t.subtotal||t.monto,derivado:t.derivado,tipo_derivacion:t.tipo_derivacion,valor_derivacion:t.valor_derivacion,laboratorio_referencia:t.laboratorio_referencia}})})).json();v.success?(p.fire("Eliminado","√çtem eliminado correctamente.","success"),S(x=>x.filter((Z,q)=>q!==s)),fetch(`${w}api_consumos_paciente.php?paciente_id=${u}`,{credentials:"include"}).then(x=>x.json()).then(x=>{x.success&&P(x)})):p.fire("Error",v.error||"No se pudo eliminar","error")}catch{p.fire("Error","Fallo de conexi√≥n con el servidor","error")}},children:"Eliminar"})})]},s)})})]})}),e.jsxs("div",{className:"font-bold text-right text-green-700 text-lg mb-4",children:["Total: S/ ",b.reduce((t,s)=>t+Number(s.subtotal||s.monto),0).toFixed(2)]}),String(a.servicio).toLowerCase()==="consulta"&&e.jsx("div",{className:"mb-3 p-2 bg-blue-50 border border-blue-200 rounded text-blue-800 text-sm",children:'Las consultas no admiten edici√≥n. Solo puedes eliminar este √≠tem. Para reprogramar, agenda una nueva cita desde "Consulta M√©dica".'}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[String(a.servicio).toLowerCase()!=="consulta"&&e.jsx("button",{className:"w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded shadow",onClick:J,children:"Editar cotizaci√≥n"}),e.jsx("button",{className:"w-full py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded shadow",onClick:G,children:"Imprimir ticket"})]})]})}),e.jsx("button",{onClick:()=>$(-1),className:"mb-4 bg-gradient-to-r from-blue-200 to-purple-200 px-4 py-2 rounded hover:bg-blue-300 flex items-center gap-2 text-blue-900 font-semibold",children:"‚Üê Volver"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(Y,{className:"text-3xl text-blue-700"}),e.jsx("h2",{className:"text-2xl font-bold text-blue-800",children:"Consumo del Paciente"})]}),e.jsxs("div",{className:"mb-6 grid grid-cols-2 gap-4 bg-blue-50 rounded-lg p-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"ID:"})," ",i.paciente_id," ",e.jsx("br",{}),e.jsx("span",{className:"font-semibold text-gray-700",children:"Nombre:"})," ",i.nombre," ",i.apellido," ",e.jsx("br",{}),e.jsx("span",{className:"font-semibold text-gray-700",children:"DNI:"})," ",i.dni]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Historia Cl√≠nica:"})," ",i.historia_clinica," ",e.jsx("br",{}),e.jsxs("span",{className:"inline-flex items-center gap-2 font-bold text-green-700 text-lg mt-2",children:[e.jsx(L,{className:"text-2xl"}),"Consumo Total: S/ ",i.consumo_total.toFixed(2)]}),i.deuda_total>0&&e.jsxs("span",{className:"inline-flex items-center gap-2 font-bold text-red-600 text-lg mt-2 ml-4",children:[e.jsx(L,{className:"text-2xl"}),"Deuda: S/ ",i.deuda_total.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-8 mb-2",children:[e.jsx(Q,{className:"text-xl text-purple-700"}),e.jsx("h4",{className:"font-semibold text-lg text-purple-800",children:"Historial de Servicios"})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"fechaInicio",className:"font-semibold text-gray-700",children:"Desde:"}),e.jsx("input",{type:"date",id:"fechaInicio",value:f,onChange:t=>E(t.target.value),className:"border rounded px-2 py-1 text-sm"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"fechaFin",className:"font-semibold text-gray-700",children:"Hasta:"}),e.jsx("input",{type:"date",id:"fechaFin",value:g,onChange:t=>F(t.target.value),className:"border rounded px-2 py-1 text-sm"})]}),e.jsx("button",{onClick:()=>{E(""),F("")},className:"bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 font-semibold",children:"Limpiar Filtros"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full border rounded-lg shadow-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"px-3 py-2 border text-left",children:"Fecha"}),e.jsx("th",{className:"px-3 py-2 border text-left",children:"Servicio"}),e.jsx("th",{className:"px-3 py-2 border text-left",children:"Descripci√≥n"}),e.jsx("th",{className:"px-3 py-2 border text-right",children:"Monto (S/)"})]})}),e.jsx("tbody",{children:_.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-center py-6 text-gray-500",children:"No hay servicios registrados."})}):H.map((t,s)=>e.jsxs("tr",{className:s%2===0?"bg-white":"bg-blue-50",children:[e.jsx("td",{className:"border px-3 py-2",children:t.fecha}),e.jsx("td",{className:"border px-3 py-2",children:e.jsxs("span",{className:`inline-block px-2 py-1 rounded text-xs font-semibold ${t.servicio==="consulta"?"bg-green-100 text-green-700":t.servicio==="laboratorio"?"bg-yellow-100 text-yellow-700":t.servicio==="farmacia"?"bg-purple-100 text-purple-700":t.servicio==="procedimiento"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:[t.servicio,t.servicio==="laboratorio"&&t.detalles&&t.detalles.some(o=>o.resultados_laboratorio)&&e.jsx("button",{className:"ml-2 text-purple-700 hover:text-purple-900",title:"Descargar resultados",onClick:()=>{const o=t.detalles.find(l=>l.resultados_laboratorio)?.resultados_laboratorio;o&&window.open(o,"_blank")},children:e.jsx("span",{role:"img","aria-label":"descargar",children:"üì•"})})]})}),e.jsx("td",{className:"border px-3 py-2",children:e.jsx("button",{className:"px-3 py-1 bg-blue-100 hover:bg-blue-200 rounded text-blue-900 font-semibold text-xs shadow",onClick:()=>{const o=(t.detalles||[]).flatMap(l=>Array.isArray(l.detalles)?l.detalles:[]);B({...t,cobro_id:t.detalles?.[0]?.cobro_id,tipo_pago:o?.[0]?.tipo_pago,cobertura:o?.[0]?.cobertura,detalles:o}),S(o),N(!0)},children:"Ver detalle"})}),e.jsx("td",{className:"border px-3 py-2 text-right font-semibold text-green-700",children:Number(t.montoTotal).toFixed(2)})]},s))})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-4 mt-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"itemsPerPage",className:"font-semibold text-gray-700",children:"Filas por p√°gina:"}),e.jsxs("select",{id:"itemsPerPage",value:h,onChange:t=>R(Number(t.target.value)),className:"border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:3,children:"3"}),e.jsx("option",{value:5,children:"5"}),e.jsx("option",{value:10,children:"10"})]})]}),j>1&&e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:`px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm font-semibold ${m===1?"opacity-50 cursor-not-allowed":""}`,onClick:()=>y(m-1),disabled:m===1,children:"Anterior"}),e.jsxs("span",{className:"font-semibold text-blue-700",children:["P√°gina ",m," de ",j]}),e.jsx("button",{className:`px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm font-semibold ${m===j?"opacity-50 cursor-not-allowed":""}`,onClick:()=>y(m+1),disabled:m===j,children:"Siguiente"})]})]})]})}export{oe as default};
