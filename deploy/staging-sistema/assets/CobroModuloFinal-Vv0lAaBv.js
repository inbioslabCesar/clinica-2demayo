import{j as e,r as i,S as d}from"./vendor-B5yQt2qK.js";import{B as $}from"./examenes-laboratorio-crud-BJk1fG4Z.js";function Z({tipoDescuento:s,setTipoDescuento:l,valorDescuento:u,setValorDescuento:E,montoOriginal:c,errorDescuento:C}){return e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block font-semibold mb-2",children:"Descuento:"}),e.jsxs("div",{className:"mb-2 flex flex-col gap-2",children:[e.jsxs("select",{value:s,onChange:h=>l(h.target.value),className:"border rounded px-3 py-2 w-full",children:[e.jsx("option",{value:"porcentaje",children:"Porcentaje (%)"}),e.jsx("option",{value:"monto",children:"Monto fijo (S/)"})]}),e.jsx("input",{type:"number",min:"0",step:"any",value:u,onChange:h=>E(Number(h.target.value)),className:"border rounded px-3 py-2 w-full",placeholder:s==="porcentaje"?"Ej: 10":"Ej: 20.00"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Monto original: ",e.jsxs("span",{className:"font-bold",children:["S/ ",c.toFixed(2)]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Descuento aplicado: ",e.jsx("span",{className:"font-bold",children:s==="porcentaje"?`${u}%`:`S/ ${u.toFixed(2)}`})]}),e.jsxs("div",{className:"text-sm text-green-700 font-bold",children:["Monto final a cobrar: S/ ",Math.max(c-(s==="porcentaje"?c*(u/100):u),0).toFixed(2)]}),C&&e.jsx("div",{className:"text-red-600 text-sm mt-1",children:C})]})}function te({paciente:s,servicio:l,onCobroCompleto:u,onCancelar:E,detalles:c,total:C}){const[h,L]=i.useState(""),[v,I]=i.useState("porcentaje"),[p,B]=i.useState(0),[R,P]=i.useState(""),[H,T]=i.useState(null),[J,O]=i.useState(!0);i.useEffect(()=>{const r=JSON.parse(sessionStorage.getItem("usuario")||"{}");fetch(`${$}api_caja_actual.php`,{credentials:"include"}).then(o=>o.json()).then(o=>{o.success&&o.caja&&o.caja.usuario_id===r.id?T(o.caja):T(null),O(!1)}).catch(()=>{T(null),O(!1)})},[]);const U=l&&["consulta","laboratorio","farmacia","rayosx","ecografia","procedimiento","operacion","hospitalizacion"].includes(l.key),[k,Y]=i.useState("particular"),[y,z]=i.useState("efectivo"),[G,oe]=i.useState(""),[F,N]=i.useState(!1);i.useEffect(()=>{c||V()},[c]);const V=async()=>{try{await(await fetch(`${$}api_tarifas.php`,{credentials:"include"})).json()}catch{}},m=i.useMemo(()=>Array.isArray(c)&&c.length>0?c:[],[c]),q=m.reduce((r,o)=>r+(o.subtotal||0),0);let _=0;v==="porcentaje"?_=q*(p/100):_=p;const K=()=>{const r=m.reduce((t,g)=>t+(g.subtotal||0),0);let o=0;return v==="porcentaje"?o=r*(p/100):o=p,Math.max(r-o,0)},Q=async()=>{if(J){d.fire("Espere","Verificando caja abierta...","info");return}if(!H){d.fire("Error","No tienes una caja abierta. Abre tu caja antes de cobrar.","error");return}if(m.length===0){d.fire("Error","No hay servicios para cobrar","error");return}if(!s||!s.nombre||!s.dni||!s.historia_clinica){d.fire("Error","Faltan datos completos del paciente (nombre, DNI o historia cl√≠nica)","error");return}N(!0);try{const r=JSON.parse(sessionStorage.getItem("usuario")||"{}"),o=m.reduce((b,f)=>b+(f.subtotal||0),0);let t=0;if(v==="porcentaje"?t=o*(p/100):t=p,t<0||t>o){P("El descuento no puede ser mayor al monto original ni negativo."),N(!1);return}else P("");const g={paciente_id:s.id,usuario_id:r.id,usuario_nombre:r.nombre||"",paciente_nombre:s.apellido?`${s.nombre} ${s.apellido}`:s.nombre,total:Math.max(o-t,0),monto_original:o,monto_descuento:t,tipo_descuento:v,valor_descuento:p,tipo_pago:y,observaciones:G,detalles:m,servicio:String(l.key),servicio_info:{key:String(l.key),label:l.label},motivo:t>0?h:""},x=await fetch(`${$}api_cobros.php`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(g)});let a;try{a=await x.json()}catch{const f=await x.text();d.fire("Error","Respuesta inesperada del servidor: "+f,"error"),N(!1);return}if(!a.success&&a.error){d.fire({icon:"error",title:"Error en el cobro",text:a.error});return}if(a.success){if(l?.key==="laboratorio"&&!l?.consulta_id){const b=m.map(A=>A.servicio_id);await(await fetch(`${$}api_ordenes_laboratorio.php`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({consulta_id:null,examenes:b,paciente_id:s?.id||null,cobro_id:a.cobro_id})})).json()}await W(a.cobro_id,g),u&&u(a.cobro_id,l)}else d.fire("Error",a.error||"Error al procesar el cobro","error")}catch{d.fire("Error","Error de conexi√≥n con el servidor","error")}finally{N(!1)}},W=async(r,o)=>{const t=new Date().toLocaleString("es-PE"),g=s.apellido?`${s.nombre} ${s.apellido}`:s.nombre,x=o.servicio_info||{},a=x.tipo_consulta||"";let b=x.hora||"",f=x.fecha||"";!b&&Array.isArray(o.detalles)&&o.detalles.length>0&&(b=o.detalles[0].hora||""),!f&&Array.isArray(o.detalles)&&o.detalles.length>0&&(f=o.detalles[0].fecha||"");const A=a==="programada"?x.numero_orden||"N/A":"",X=window.location.hostname==="localhost"?"/public/2demayo.svg":"/logo-clinica.png",S=x.key==="consulta";let j="";if(Array.isArray(o.detalles))for(const n of o.detalles){if(n.medico_nombre){j=n.medico_nombre;break}if(n.medico){j=n.medico;break}}!j&&o.servicio_info&&o.servicio_info.medico_nombre&&(j=o.servicio_info.medico_nombre);const D=`
      <div style="text-align: left; font-family: monospace;">
        <div style="text-align: center; margin-bottom: 0;">
          <img src='${X}' alt='Logo Cl√≠nica 2 de Mayo' style='height:60px; margin-bottom:4px; display:block; margin-left:auto; margin-right:auto;' />
          <h3 style="text-align: center; margin-bottom: 20px; margin-top: 4px;">CL√çNICA 2 DE MAYO</h3>
        </div>
        <hr>
        <p><strong>COMPROBANTE DE PAGO #${r}</strong></p>
        <p>Fecha: ${t}</p>
        <p>Paciente: ${g}</p>
        <p>DNI: ${s.dni}</p>
        <p>H.C.: ${s.historia_clinica}</p>
        ${S?`<p>Tipo de consultas: ${a==="programada"?"Programada":"Espont√°nea"}</p>`:""}
        ${S&&a==="programada"?`<p>Fecha de consulta: ${f}</p>`:""}
        ${S?`<p>Hora de consulta: ${b}</p>`:""}
        ${S&&a==="programada"?`<p>N¬∞ Orden de llegada: ${A}</p>`:""}
        ${j?`<p>M√©dico: ${j}</p>`:""}
        <hr>
        <p><strong>DETALLE:</strong></p>
        ${o.detalles.map(n=>`<p>${n.descripcion.length>50?n.descripcion.slice(0,47)+"...":n.descripcion} x${n.cantidad} .... S/ ${n.subtotal.toFixed(2)}</p>`).join("")}
        <hr>
          ${o.monto_descuento&&o.monto_descuento>0?`
            <p style="color: #d97706;"><strong>DESCUENTO:</strong> -S/ ${o.monto_descuento.toFixed(2)} (${o.tipo_descuento==="porcentaje"?o.valor_descuento+"%":"Monto fijo"})</p>
          `:""}
        <p><strong>TOTAL: S/ ${o.total.toFixed(2)}</strong></p>
        <p>Tipo de pago: ${y==="yape"?"Yape":y.toUpperCase()}</p>
        <p>Cobertura: ${k.toUpperCase()}</p>
        <hr>
        <p style="text-align: center; font-size: 12px;">
          Gracias por su preferencia<br>
          Conserve este comprobante
        </p>
      </div>
    `;await d.fire({title:"Cobro Procesado ‚úÖ",html:D,icon:"success",confirmButtonText:"Imprimir Comprobante",showCancelButton:!0,cancelButtonText:"Solo Continuar"}).then(n=>{if(n.isConfirmed){const w=window.open("","_blank");w.document.write(D),w.document.close(),w.print()}})};if(!l)return e.jsx("div",{children:"Seleccione un servicio primero"});if(!U)return e.jsxs("div",{className:"bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-6 rounded",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"‚ö†Ô∏è Solo se pueden procesar cobros de servicios m√©dicos"}),e.jsx("p",{children:"Este m√≥dulo no permite cobrar egresos operativos ni otros tipos de egresos. Por favor, utilice el formulario de egresos operativos para registrar gastos administrativos, compras, pagos de servicios, etc."})]});const M=K();return e.jsxs("div",{className:"bg-white p-8 md:p-12 rounded-2xl shadow-2xl border border-blue-200 max-w-2xl lg:max-w-4xl mx-auto mt-8 lg:mt-12",children:[e.jsxs("h3",{className:"text-2xl font-bold mb-6 text-blue-800 flex items-center gap-2",children:[e.jsx("span",{className:"text-3xl",children:"üí∞"})," M√≥dulo de Cobros"]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12",children:[e.jsxs("div",{className:"space-y-6 flex flex-col justify-between h-full",children:[e.jsxs("div",{className:"bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("h4",{className:"font-semibold mb-2 text-gray-700 flex items-center gap-2 text-lg",children:[e.jsx("span",{className:"text-blue-500",children:"üë§"})," Paciente"]}),e.jsx("div",{className:"text-xl font-bold",children:s.nombre}),e.jsxs("div",{className:"text-base text-gray-600",children:["DNI: ",s.dni," | H.C.: ",s.historia_clinica]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-2",children:"Tipo de Cobertura:"}),e.jsxs("select",{value:k,onChange:r=>Y(r.target.value),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-300 text-base",children:[e.jsx("option",{value:"particular",children:"Particular"}),e.jsx("option",{value:"seguro",children:"Seguro"}),e.jsx("option",{value:"convenio",children:"Convenio"})]})]}),_>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block font-semibold mb-2",children:["Motivo del descuento ",e.jsx("span",{className:"text-red-500",children:"*"}),":"]}),e.jsx("textarea",{value:h,onChange:r=>L(r.target.value),className:"w-full border rounded-lg px-3 py-2 h-20 focus:ring-2 focus:ring-blue-300 text-base",placeholder:"Motivo o justificaci√≥n del descuento (obligatorio)",required:_>0})]})]}),e.jsxs("div",{className:"space-y-6 flex flex-col justify-between h-full",children:[e.jsxs("div",{className:"bg-blue-50 p-6 rounded-2xl border border-blue-100 shadow-sm",children:[e.jsxs("h4",{className:"font-semibold mb-2 text-blue-700 flex items-center gap-2 text-lg",children:[e.jsx("span",{className:"text-blue-400",children:"üßæ"})," Detalle del Servicio"]}),m.map((r,o)=>{let t=r.subtotal;return(typeof t!="number"||t<=0)&&typeof r.precio_publico=="number"&&(t=r.precio_publico),e.jsxs("div",{className:"flex justify-between items-center text-base",children:[e.jsx("span",{children:r.descripcion}),e.jsxs("span",{className:"font-bold",children:["S/ ",t>0?t.toFixed(2):"‚Äî"]})]},o)}),e.jsx("hr",{className:"my-3"}),e.jsxs("div",{className:"flex justify-between items-center font-bold text-xl",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-green-600",children:["S/ ",M.toFixed(2)]})]})]}),e.jsx("div",{className:"bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm",children:e.jsx(Z,{tipoDescuento:v,setTipoDescuento:I,valorDescuento:p,setValorDescuento:B,montoOriginal:m.reduce((r,o)=>r+(o.subtotal||0),0),errorDescuento:R})}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-2",children:"M√©todo de Pago:"}),e.jsxs("select",{value:y,onChange:r=>z(r.target.value),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-300 text-base",children:[e.jsx("option",{value:"efectivo",children:"Efectivo"}),e.jsx("option",{value:"tarjeta",children:"Tarjeta"}),e.jsx("option",{value:"transferencia",children:"Transferencia"}),e.jsx("option",{value:"yape",children:"Yape"}),e.jsx("option",{value:"plin",children:"Plin"})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mt-4",children:[e.jsx("button",{onClick:Q,disabled:F||M<=0,className:"flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-green-700 disabled:bg-gray-400 transition-all shadow-md",children:F?"Procesando...":`üí≥ Cobrar S/ ${M.toFixed(2)}`}),e.jsx("button",{onClick:E,className:"flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-gray-600 transition-all shadow-md",children:"Cancelar"})]})]})]})]})}export{te as C};
