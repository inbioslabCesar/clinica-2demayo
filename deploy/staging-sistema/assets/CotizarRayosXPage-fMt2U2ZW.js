import{r as b,t as ae,u as ie,k as se,j as o,S as C}from"./vendor-B5yQt2qK.js";import{B as N}from"./examenes-laboratorio-crud-BJk1fG4Z.js";import{C as ce}from"./CobroModuloFinal-Vv0lAaBv.js";function ue(){const[A,X]=b.useState(""),[M,I]=b.useState(!1),[D,J]=b.useState([]),[V,G]=b.useState(0),{pacienteId:z}=ae(),k=ie(),p=se(),[y,H]=b.useState(null),[j,K]=b.useState([]),[U,W]=b.useState([]),[x,w]=b.useState([]),[v,S]=b.useState({}),[q,B]=b.useState(""),[Q,T]=b.useState({}),[O,P]=b.useState([]),[R,L]=b.useState(null),Y=j.filter(e=>{const t=`${e.descripcion||e.nombre}`.toLowerCase();let r=null;e&&e.medico_id&&(r=U.find(d=>d.id===e.medico_id));const n=r?`${r.nombres||r.nombre} ${r.apellidos||r.apellido}`.toLowerCase():"sin doctor";return t.includes(A.toLowerCase())||n.includes(A.toLowerCase())});b.useEffect(()=>{fetch(`${N}api_pacientes.php?id=${z}`).then(e=>e.json()).then(e=>{e.success&&e.paciente&&H(e.paciente)}),fetch(`${N}api_tarifas.php`,{credentials:"include"}).then(e=>e.json()).then(e=>{const t=(e.tarifas||[]).filter(r=>r.servicio_tipo==="rayosx").map(r=>({...r,id:Number(r.id),medico_id:r.medico_id!==void 0&&r.medico_id!==null?Number(r.medico_id):r.medico_id,precio_particular:Number(r.precio_particular||r.precio||0)}));K(t)}),fetch(`${N}api_medicos.php`,{credentials:"include"}).then(e=>e.json()).then(e=>{W(e.medicos||[])})},[z]),b.useEffect(()=>{fetch(`${N}api_caja_estado.php`,{credentials:"include"}).then(e=>e.json()).then(e=>L(e?.estado||"cerrada")).catch(()=>L("cerrada"))},[]),b.useEffect(()=>{const e=new URLSearchParams(p.search),t=e.get("cobro_id"),r=e.get("cotizacion_id"),n=[];(t||r)&&P([]),t&&n.push(fetch(`${N}api_cobros.php?cobro_id=${t}`,{credentials:"include"}).then(d=>d.json()).then(d=>{const u=d.cobro||d?.result?.cobro||null;if(!d.success||!u)return;const _=Array.isArray(u.detalles)?u.detalles:[],h=[];if(_.forEach(a=>{if((a.servicio_tipo||"").toLowerCase()==="rayosx")try{const s=JSON.parse(a.descripcion);Array.isArray(s)&&h.push(...s)}catch{}}),h.length){P(i=>[...i,...h]);const a=Array.from(new Set(h.map(i=>Number(i.servicio_id)).filter(Boolean)));w(a);const s={},l={};h.forEach(i=>{const c=Number(i.servicio_id);s[c]=(s[c]||0)+Number(i.cantidad||1),l[c]=s[c]}),S(i=>({...i,...l})),T(s)}})),r&&n.push(fetch(`${N}api_cotizaciones.php?cotizacion_id=${r}`,{credentials:"include"}).then(d=>d.json()).then(d=>{const u=d.cotizacion||null;if(!d.success||!u)return;const h=(Array.isArray(u.detalles)?u.detalles:[]).filter(a=>(a.servicio_tipo||"").toLowerCase()==="rayosx");if(h.length){P(i=>[...i,...h]);const a=Array.from(new Set(h.map(i=>Number(i.servicio_id)).filter(Boolean)));w(a);const s={},l={};h.forEach(i=>{const c=Number(i.servicio_id);s[c]=(s[c]||0)+Number(i.cantidad||1),l[c]=s[c]}),S(i=>({...i,...l})),T(s)}})),n.length&&Promise.all(n).catch(()=>{})},[p.search]);const Z=async()=>{const e=new URLSearchParams(p.search).get("cobro_id");if(!e)return;try{const a=await fetch(`${N}api_caja_estado.php`,{credentials:"include"}).then(s=>s.json());if(!a?.success||a?.estado!=="abierta"){L(a?.estado||"cerrada"),C.fire("Error","No hay caja abierta. Abre caja para actualizar este cobro.","error");return}L("abierta")}catch{C.fire("Error","No se pudo verificar el estado de la caja.","error");return}const t=new Set([...x.map(Number),...Object.keys(Q||{}).map(Number)]),r=[],n=[];if(t.forEach(a=>{const l=x.includes(Number(a))?Number(v[a]||1):0,i=Number(Q[a]||0),c=l-i;if(c>0){const m=j.find(E=>Number(E.id)===Number(a));if(!m)return;r.push({servicio_id:Number(a),descripcion:m.descripcion||m.nombre,cantidad:c,precio_unitario:m.precio_particular,subtotal:m.precio_particular*c,medico_id:m.medico_id||"",especialidad:m.especialidad||""})}else c<0&&n.push({servicio_id:Number(a),cantidad_eliminar:Math.abs(c)})}),r.length===0&&n.length===0){C.fire("Sin cambios","No hay cambios para aplicar.","info");return}let d="";if(n.length>0){const a=await C.fire({title:"Motivo de la reducci√≥n/eliminaci√≥n",input:"text",inputPlaceholder:"Escribe un motivo",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",inputValidator:s=>{if(!s||!s.trim())return"Motivo requerido"}});if(!a.isConfirmed)return;d=(a.value||"").toString().trim()}let u=Array.isArray(O)?[...O]:[];const _=[...r],h=(a,s,l)=>{let i=-1,c=-1,m=-1,E=-1;for(let f=0;f<a.length;f++){const $=a[f];if(Number($?.servicio_id)!==Number(s))continue;const g=Number($?.cantidad||0);if(!(g<=0)){if(g===l){i=f;break}g>l&&(c===-1||g<Number(a[c]?.cantidad||0))&&(c=f),g>E&&(E=g,m=f)}}return i!==-1?i:c!==-1?c:m};try{for(const s of n){let l=Number(s.cantidad_eliminar||0);for(;l>0;){const i=h(u,s.servicio_id,l);if(i===-1)throw new Error("No se encontr√≥ el √≠tem a reducir en el cobro.");const c=u[i],m=Number(c?.cantidad||0);if(m<=0)throw new Error("Cantidad inv√°lida en el detalle del cobro.");const f=await(await fetch(`${N}api_cobro_eliminar_item.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(e),servicio_tipo:"rayosx",item:c,motivo:d})})).json();if(!f?.success)throw new Error(f?.error||"No se pudo eliminar el √≠tem del cobro.");if(u.splice(i,1),m>l){const $=m-l,g=Number(c?.precio_unitario||0)||Number(c?.subtotal||0)/Math.max(1,m);_.push({...c,cantidad:$,precio_unitario:g,subtotal:g*$}),l=0}else l-=m}}if(_.length>0){const l=await(await fetch(`${N}api_cobro_actualizar.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(e),servicio_tipo:"rayosx",items:_})})).json();if(!l?.success)throw new Error(l?.error||"No se pudo actualizar el cobro");u=[...u,..._]}const a={};t.forEach(s=>{const i=x.includes(Number(s))?Number(v[s]||1):0;i>0&&(a[Number(s)]=i)}),T(a),P(u),C.fire("Actualizado","Se aplicaron los cambios en el cobro.","success")}catch(a){C.fire("Error",a?.message||"Fallo de conexi√≥n con el servidor","error")}},ee=e=>{const t=Number(e);w(r=>r.includes(t)?r:[...r,t]),S(r=>({...r,[t]:1}))},re=e=>{const t=Number(e);w(r=>r.filter(n=>n!==t)),S(r=>{const n={...r};return delete n[t],n})},oe=(e,t)=>{const r=Number(e);S(n=>({...n,[r]:t}))},F=()=>x.reduce((e,t)=>{const r=j.find(d=>Number(d.id)===Number(t)),n=v[t]||1;return r?e+r.precio_particular*n:e},0),te=async()=>{if(x.length===0){B("Selecciona al menos un estudio de Rayos X.");return}const e=x.map(t=>{const r=j.find(u=>u.id===t),n=v[t]||1;let d=null;return r&&r.medico_id!==void 0&&r.medico_id!==null&&(d=U.find(u=>Number(u.id)===Number(r.medico_id))),r?{servicio_tipo:"rayosx",servicio_id:t,descripcion:r.descripcion||r.nombre,cantidad:n,precio_unitario:r.precio_particular,subtotal:r.precio_particular*n,medico_nombre:d?`${d.nombres||d.nombre} ${d.apellidos||d.apellido}`:"Sin doctor"}:null}).filter(Boolean);J(e),G(F()),I(!0)};return o.jsxs("div",{className:"max-w-7xl mx-auto p-10 bg-white rounded-2xl shadow-2xl mt-8 border border-blue-100",children:[(()=>{const e=new URLSearchParams(p.search),t=e.get("cobro_id"),r=e.get("cotizacion_id");return!(t||r)?o.jsx("button",{onClick:()=>k("/seleccionar-servicio",{state:{pacienteId:z}}),className:"mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-semibold",children:"‚Üê Volver"}):o.jsx("button",{onClick:()=>k(z?`/consumo-paciente/${z}${t?`?cobro_id=${t}`:""}`:"/pacientes"),className:"mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-semibold",children:"‚Üê Volver a Consumo del Paciente"})})(),o.jsxs("h2",{className:"text-2xl font-bold text-blue-900 mb-4 flex items-center gap-2",children:[o.jsx("span",{role:"img","aria-label":"rayosx",children:"ü©ª"})," Cotizador de Rayos X"]}),(new URLSearchParams(p.search).get("cobro_id")||new URLSearchParams(p.search).get("cotizacion_id"))&&o.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-300",children:new URLSearchParams(p.search).get("cobro_id")?`Editando cobro #${new URLSearchParams(p.search).get("cobro_id")}`:`Editando cotizaci√≥n #${new URLSearchParams(p.search).get("cotizacion_id")}`}),y&&o.jsxs("div",{className:"mb-4 p-2 bg-blue-50 rounded text-blue-800 text-sm",children:[o.jsx("span",{className:"font-bold",children:"Paciente:"})," ",y.nombres||y.nombre," ",y.apellidos||y.apellido," (DNI: ",y.dni,")"]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[o.jsxs("div",{className:"mb-4 max-h-[500px] overflow-y-auto",children:[o.jsxs("div",{className:"font-bold mb-2 flex flex-col gap-2",children:[o.jsx("span",{children:"Estudios disponibles:"}),o.jsx("input",{type:"text",placeholder:"Buscar estudio, descripci√≥n o doctor...",value:A,onChange:e=>X(e.target.value),className:"border px-3 py-2 rounded-lg w-full max-w-md"})]}),j.length===0?o.jsx("div",{className:"text-gray-500",children:"No hay estudios de Rayos X registrados."}):o.jsx("ul",{className:"divide-y divide-gray-100",children:Y.map(e=>{let t=null;return e&&e.medico_id&&(t=U.find(r=>r.id===e.medico_id)),o.jsxs("li",{className:"flex items-center gap-4 py-3 px-2 hover:bg-blue-50 rounded-lg transition-all",children:[o.jsxs("div",{className:"flex-1",children:[o.jsx("div",{className:"font-semibold text-gray-800",children:e.descripcion||e.nombre}),o.jsxs("div",{className:"text-xs text-gray-500",children:["Precio: S/ ",e.precio_particular]}),o.jsxs("div",{className:"text-xs text-blue-700 mt-1",children:["Doctor: ",t?`${t.nombres||t.nombre} ${t.apellidos||t.apellido}`:"Sin doctor"]})]}),x.includes(Number(e.id))?o.jsxs(o.Fragment,{children:[o.jsx("input",{type:"number",min:1,value:v[Number(e.id)]||1,onChange:r=>oe(Number(e.id),Math.max(1,Number(r.target.value))),className:"border rounded-lg px-2 w-16 bg-white"}),o.jsx("button",{onClick:()=>re(Number(e.id)),className:"ml-2 w-10 h-10 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-700 text-xl shadow transition","aria-label":"Quitar",children:"‚úï"})]}):o.jsx("button",{onClick:()=>ee(Number(e.id)),className:"w-10 h-10 flex items-center justify-center rounded-full bg-green-100 hover:bg-green-200 text-green-700 text-xl shadow transition","aria-label":"Agregar",children:"+"})]},e.id)})})]}),o.jsxs("div",{className:"w-full md:max-w-xl md:sticky md:top-8 h-fit",children:[x.length>0&&!M&&o.jsxs("div",{className:"mb-6",children:[o.jsxs("h4",{className:"font-semibold text-blue-700 mb-4 flex items-center gap-2",children:[o.jsx("span",{children:"üìù"}),"Resumen de Cotizaci√≥n"]}),o.jsx("ul",{className:"divide-y divide-gray-100 mb-2 bg-gray-50 rounded-lg shadow p-4 max-h-80 overflow-y-auto",children:x.map(e=>{const t=j.find(n=>Number(n.id)===Number(e)),r=v[e]||1;return t?o.jsxs("li",{className:"py-2 flex flex-col md:flex-row justify-between items-center gap-2",children:[o.jsx("span",{className:"w-full md:w-1/2",children:t.descripcion||t.nombre}),o.jsxs("span",{className:"w-full md:w-1/4",children:[r," estudio(s)"]}),o.jsxs("span",{className:"font-bold text-green-700 w-full md:w-1/4",children:["S/ ",(t.precio_particular*r).toFixed(2)]})]},e):null})}),o.jsxs("div",{className:"mt-4 text-lg font-bold text-right",children:["Total: ",o.jsxs("span",{className:"text-green-600",children:["S/ ",F().toFixed(2)]})]}),o.jsxs("div",{className:"flex gap-3 mt-4 justify-end",children:[o.jsx("button",{onClick:()=>{w([]),B("")},className:"bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200",children:"Limpiar selecci√≥n"}),new URLSearchParams(p.search).get("cobro_id")?o.jsx("button",{onClick:Z,disabled:R==="cerrada",className:`px-6 py-2 rounded font-bold ${R==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:"Actualizar cobro"}):o.jsx("button",{onClick:te,disabled:R==="cerrada",className:`px-6 py-2 rounded font-bold ${R==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:"Registrar Cotizaci√≥n"}),(new URLSearchParams(p.search).get("cobro_id")||!new URLSearchParams(p.search).get("cobro_id"))&&R==="cerrada"&&o.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[o.jsxs("span",{className:"text-sm text-red-600",children:["Caja cerrada: abre una caja para poder ",new URLSearchParams(p.search).get("cobro_id")?"actualizar":"cobrar","."]}),o.jsx("button",{onClick:()=>k("/contabilidad"),className:"text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded border border-yellow-300 hover:bg-yellow-200",children:"Ir a Contabilidad"})]})]})]}),M&&o.jsx(ce,{paciente:y,servicio:{key:"rayosx",label:"Rayos X"},detalles:D,total:V,onCobroCompleto:()=>{I(!1),w([]),S({}),B("Cobro procesado correctamente.")},onCancelar:()=>I(!1)})]})]}),q&&o.jsx("div",{className:"mt-4 text-center font-semibold text-green-600",children:q})]})}export{ue as default};
