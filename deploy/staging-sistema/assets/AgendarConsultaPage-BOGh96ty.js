import{r as n,j as e,n as W,u as J,o as X,p as Y,S as Z,k as I}from"./vendor-B5yQt2qK.js";import{B as w}from"./examenes-laboratorio-crud-BJk1fG4Z.js";import{u as q}from"./useDisponibilidadMedico-BnDsnWx8.js";import{C as ee}from"./CobroModuloFinal-Vv0lAaBv.js";function se(){const[a,p]=n.useState([]),[u,j]=n.useState([]),[y,h]=n.useState(""),[v,N]=n.useState(new Date),{disponibilidad:b,loading:A}=q(),M=["#22c55e","#3b82f6","#f59e42","#e11d48","#a21caf","#facc15","#0ea5e9","#14b8a6","#6366f1","#f472b6"],E=Array.isArray(a)?a:[],$=E.reduce((s,r,l)=>(s[r.id]=M[l%M.length],s),{});n.useEffect(()=>{Promise.all([fetch(`${w}api_medicos.php`).then(s=>s.json()),fetch(`${w}api_consultas.php`).then(s=>s.json())]).then(([s,r])=>{p(s.medicos||[]),j(r.consultas||[])})},[]);const o={};b.forEach(s=>{s.fecha&&(o[s.fecha]||(o[s.fecha]=[]),o[s.fecha].push(s))});function x(s){const r=s.toISOString().slice(0,10),l=b.filter(m=>m.fecha===r);if(l.length>0)return l;const f=["domingo","lunes","martes","miércoles","jueves","viernes","sábado"][s.getDay()];return b.filter(m=>m.dia_semana===f&&!m.fecha)}const H=x(v),R=y.trim().toLowerCase();let C=[];R?C=b.filter(s=>{const r=E.find(l=>l.id==s.medico_id);return r?r.nombre&&r.nombre.toLowerCase().includes(R)||r.especialidad&&r.especialidad.toLowerCase().includes(R):!1}):C=H;const k=C;return e.jsxs("div",{className:"mb-6 w-full",children:[e.jsx("h3",{className:"font-extrabold text-xl mb-4 text-center text-blue-700 tracking-tight",children:"Disponibilidad de Médicos"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-8 mb-4 items-start justify-center w-full",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-white rounded-2xl shadow-lg border border-blue-200 p-4 flex flex-col items-center w-full max-w-[320px] md:max-w-lg",children:e.jsx(W,{onChange:N,value:v,className:"border rounded-xl shadow text-base md:text-lg w-[280px] h-[340px] md:w-[360px] md:h-[420px] bg-white",tileContent:({date:s,view:r})=>{if(r!=="month")return null;const l=x(s);if(!l.length)return null;const g=[...new Set(l.map(f=>f.medico_id))];return e.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:2},children:g.map((f,m)=>e.jsx("span",{style:{display:"inline-block",width:8,height:8,borderRadius:"50%",background:$[f]||"#888",marginLeft:m>0?2:0}},f))})}})}),e.jsxs("div",{className:"flex-1 w-full max-w-lg",children:[e.jsx("div",{className:"flex justify-end mb-3",children:e.jsx("input",{type:"text",placeholder:"Buscar por nombre o especialidad...",value:y,onChange:s=>h(s.target.value),className:"border-2 border-blue-200 rounded-full px-4 py-2 shadow focus:ring-2 focus:ring-blue-300 w-full max-w-xs text-base"})}),A?e.jsx("div",{className:"text-center text-blue-600 font-semibold",children:"Cargando..."}):e.jsx("div",{className:"overflow-x-auto bg-white rounded-xl shadow border border-gray-200",style:{maxHeight:260,minHeight:80},children:e.jsxs("table",{className:"min-w-full text-[12px] md:text-base border-separate border-spacing-y-1",children:[e.jsx("thead",{className:"bg-blue-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-blue-700 font-bold rounded-tl-xl",children:"Médico"}),e.jsx("th",{className:"px-2 py-2 text-blue-700 font-bold",children:"Especialidad"}),e.jsx("th",{className:"px-2 py-2 text-blue-700 font-bold",children:"Horario"}),e.jsx("th",{className:"px-2 py-2 text-blue-700 font-bold rounded-tr-xl",children:"Cupos libres"})]})}),e.jsx("tbody",{children:k.map((s,r)=>{const l=E.find(_=>_.id==s.medico_id);if(!l)return null;let g=s.fecha;!g&&s.dia_semana&&(g=s.dia_semana);const f=s.hora_inicio.split(":").map(Number),m=s.hora_fin.split(":").map(Number);let c=0,T=f[0],S=f[1];for(;T<m[0]||T===m[0]&&S<m[1];)c++,S+=30,S>=60&&(T++,S=0);const B=u.filter(_=>_.medico_id==l.id&&(s.fecha?_.fecha===s.fecha:!0)&&_.hora>=s.hora_inicio&&_.hora<s.hora_fin&&_.estado==="pendiente"),L=c-B.length;return e.jsxs("tr",{className:L>0?"bg-green-50":"bg-yellow-100",children:[e.jsxs("td",{className:"px-2 py-2 font-bold rounded-l-xl",style:{color:$[l.id]||void 0},children:["Dr(a). ",l.nombre," ",l.apellido||""]}),e.jsx("td",{className:"px-2 py-2",children:l.especialidad}),e.jsxs("td",{className:"px-2 py-2",children:[s.hora_inicio," - ",s.hora_fin," ",g?e.jsxs("span",{className:"text-xs text-gray-500 ml-1",children:["(",g,")"]}):null]}),e.jsx("td",{className:"px-2 py-2 font-bold rounded-r-xl",children:L>0?L:e.jsx("span",{className:"text-red-600",children:"Sin cupos"})})]},s.medico_id+"-"+r)})})]})})]})]})]})}function te({tipoConsulta:a,setTipoConsulta:p,tarifas:u,medicoId:j,setMedicoId:y,fecha:h,setFecha:v,hora:N,setHora:b,horariosDisponibles:A,cargandoHorarios:M,handleSubmit:E,msg:$}){return e.jsx("div",{className:"w-full md:w-[700px] flex flex-col items-center md:pl-0",children:e.jsxs("form",{onSubmit:E,className:"flex flex-col gap-2 md:gap-4 mb-4 bg-white rounded-2xl shadow-xl border border-green-200 p-8 w-full max-w-2xl text-xs md:text-base",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Tipo de Consulta:"}),e.jsxs("select",{value:a,onChange:o=>p(o.target.value),className:"border rounded px-3 py-2 w-full",children:[e.jsx("option",{value:"programada",children:"Programada"}),e.jsx("option",{value:"espontanea",children:"Espontánea"})]})]}),e.jsx("label",{className:"font-semibold mb-1",htmlFor:"medico-select",children:"Médico"}),e.jsxs("select",{id:"medico-select",value:j,onChange:o=>{y(o.target.value),b("")},className:"border rounded px-3 py-2 md:px-4 md:py-3 text-base md:text-lg",required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un médico"}),u.map((o,x)=>e.jsxs("option",{value:o.medico_id,children:["Dr(a). ",o.medico_nombre," ",o.medico_apellido," — ",o.descripcion]},`${o.medico_id}-${o.tarifa_id||x}`))]}),e.jsx("label",{className:"font-semibold mb-1",htmlFor:"fecha-input",children:"Fecha de la consulta"}),e.jsx("input",{id:"fecha-input",type:"date",value:h,onChange:o=>v(o.target.value),className:"border rounded px-3 py-2 md:px-4 md:py-3 text-base md:text-lg",required:!0}),a==="programada"?e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"font-semibold mb-1",htmlFor:"hora-select",children:"Horario disponible"}),e.jsxs("select",{id:"hora-select",value:N,onChange:o=>b(o.target.value),className:"border rounded px-3 py-2 md:px-4 md:py-3 text-base md:text-lg",required:!0,disabled:!j||!h?!0:M,children:[e.jsx("option",{value:"",children:M?"Cargando horarios...":!j||!h?"Selecciona médico y fecha primero":A.length===0?"No hay horarios disponibles":"Selecciona un horario"}),A.map(o=>e.jsxs("option",{value:o.hora,children:[o.hora," - ",o.medico_nombre]},`${o.medico_id}-${o.hora}`))]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"font-semibold mb-1",htmlFor:"hora-input",children:"Hora de consulta"}),e.jsx("input",{id:"hora-input",type:"time",value:N,onChange:o=>b(o.target.value),className:"border rounded px-3 py-2 md:px-4 md:py-3 text-base md:text-lg",required:!0})]}),e.jsx("button",{type:"submit",className:"bg-green-600 text-white rounded px-4 py-2 md:px-6 md:py-3 font-bold text-base md:text-lg",children:"Agendar Consulta"}),$&&e.jsx("div",{className:"mt-2 text-base md:text-lg text-center text-green-700",children:$})]})})}function ae({consultaCreada:a,pacienteInfo:p,detallesConsulta:u,totalConsulta:j,manejarCobroCompleto:y,manejarCancelarCobro:h}){return!a||!p?null:e.jsxs("div",{className:"max-w-2xl mx-auto p-2 md:p-8 w-full",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200",children:[e.jsx("h3",{className:"font-semibold text-blue-800 mb-2",children:"✅ Consulta Agendada Exitosamente"}),e.jsxs("div",{className:"text-sm text-blue-600",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Médico:"})," ",a.medico_nombre," (",a.medico_especialidad,")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha:"})," ",a.fecha," - ",e.jsx("strong",{children:"Hora:"})," ",a.hora]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Paciente:"})," ",p.nombre," ",p.apellido]})]})]}),e.jsx(ee,{paciente:p,servicio:{key:"consulta",label:`Consulta - ${a.medico_nombre}`,medico_id:a.medico_id,consulta_id:a.id,tipo_consulta:a.tipo_consulta,hora:a.hora},detalles:u.map(v=>({...v,hora:a.hora})),total:j,onCobroCompleto:y,onCancelar:h})]})}function oe({pacienteId:a}){const p=J(),[u,j]=n.useState("programada"),[y,h]=n.useState([]),[v,N]=n.useState(0),[b,A]=n.useState([]),[M,E]=n.useState([]),[$,o]=n.useState([]),[x,H]=n.useState(""),[R,C]=n.useState([]),k=()=>{const d=new Date,i=d.getTime()+d.getTimezoneOffset()*6e4;return new Date(i+-300*6e4).toISOString().split("T")[0]},[s,r]=n.useState(k()),[l,g]=n.useState(""),[f,m]=n.useState(""),[c,T]=n.useState(null),[S,B]=n.useState(!1),[L,_]=n.useState(null),[V,U]=n.useState(!1),z=Y(Z);n.useEffect(()=>{S&&c?fetch(w+"api_tarifas.php",{credentials:"include"}).then(t=>t.json()).then(t=>{if(t.success&&Array.isArray(t.tarifas)){let d=t.tarifas.find(i=>i.servicio_tipo==="consulta"&&i.activo===1&&Number(i.medico_id)===Number(c.medico_id));if(d||(d=t.tarifas.find(i=>i.servicio_tipo==="consulta"&&i.activo===1&&(!i.medico_id||i.medico_id===null))),d){const i={servicio_tipo:"consulta",tarifa_id:d.id,descripcion:d.descripcion,cantidad:1,precio_unitario:parseFloat(d.precio_particular)||0,subtotal:parseFloat(d.precio_particular)||0,consulta_id:c.id,medico_id:c.medico_id,medico_nombre:c.medico_nombre,medico_especialidad:c.medico_especialidad,paciente_id:c.paciente_id,fecha:c.fecha};h([i]),N(i.subtotal)}else h([]),N(0)}}):(h([]),N(0))},[S,c]),n.useEffect(()=>{Promise.all([fetch(w+"api_medicos.php").then(t=>t.json()),fetch(w+"api_tarifas.php").then(t=>t.json())]).then(([t,d])=>{const i=t.medicos||[];A(i);const D=(d.tarifas||[]).filter(P=>P.servicio_tipo==="consulta"&&P.activo===1&&P.medico_id);o(D);const F=D.map(P=>String(P.medico_id)),O=i.filter(P=>F.includes(String(P.id)));E(O)})},[]),n.useEffect(()=>{x&&s?(U(!0),fetch(`${w}api_horarios_disponibles.php?medico_id=${x}&fecha=${s}`).then(t=>t.json()).then(t=>{t.success?C(t.horarios_disponibles||[]):(C([]),console.error("Error:",t.error))}).catch(t=>{console.error("Error:",t),C([])}).finally(()=>U(!1))):C([])},[x,s]),n.useEffect(()=>{a&&fetch(`${w}api_pacientes.php?id=${a}`).then(t=>t.json()).then(t=>{t.success&&t.paciente&&_(t.paciente)}).catch(console.error)},[a]);const G=async t=>{if(t.preventDefault(),m(""),!a||!x||!s||!l){m("Completa todos los campos");return}if(u==="espontanea"){const d=JSON.parse(sessionStorage.getItem("usuario")||"{}");let i=null;try{const F=await(await fetch(w+"api_caja_actual.php",{credentials:"include"})).json();F.success&&F.caja&&F.caja.usuario_id===d.id&&(i=F.caja)}catch{i=null}if(!i){m("Debes abrir tu caja antes de agendar una consulta espontánea.");return}}try{const i=await(await fetch(w+"api_consultas.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paciente_id:a,medico_id:x,fecha:s,hora:l,tipo_consulta:u})})).json();if(i.success){const D=b.find(O=>String(O.id)===String(x)),F=`${D?.nombre} ${D?.apellido||""}`.trim();T({id:i.consulta_id||i.id,medico_id:x,medico_nombre:F,tipo_consulta:u,medico_especialidad:D?.especialidad,fecha:s,hora:l,paciente_id:a}),B(!0),m("")}else m(i.error||"Error al agendar")}catch(d){console.error("Error:",d),m("Error de conexión")}},K=async(t,d)=>{B(!1),z.fire({icon:"success",title:"¡Consulta Agendada y Pagada!",html:`
        <div class="text-left">
          <p><strong>Consulta:</strong> ${c.medico_nombre}</p>
          <p><strong>Especialidad:</strong> ${c.medico_especialidad}</p>
          <p><strong>Fecha:</strong> ${c.fecha}</p>
          <p><strong>Hora:</strong> ${c.hora}</p>
          <p><strong>Cobro ID:</strong> ${t}</p>
        </div>
      `,confirmButtonColor:"#22c55e",confirmButtonText:"Aceptar"}),r(""),g(""),H(""),T(null)},Q=()=>{B(!1),z.fire({title:"Cobro Cancelado",text:"La consulta fue agendada pero no se realizó el cobro. Puede cobrarse posteriormente.",icon:"info",confirmButtonText:"Entendido"})};return S&&c&&L?e.jsx(ae,{consultaCreada:c,pacienteInfo:L,detallesConsulta:y,totalConsulta:v,manejarCobroCompleto:K,manejarCancelarCobro:Q}):e.jsxs("div",{className:"w-full flex flex-col items-center py-8 px-2 md:px-0 bg-gradient-to-br from-gray-50 to-blue-50 min-h-[80vh]",children:[!(new URLSearchParams(window.location.search).get("cobro_id")||new URLSearchParams(window.location.search).get("cotizacion_id"))&&e.jsx("button",{onClick:()=>p("/seleccionar-servicio",{state:{pacienteId:a}}),className:"bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 self-end mb-4",children:"Volver"}),e.jsxs("div",{className:"w-full max-w-[2100px] flex flex-col md:flex-row gap-16 items-start justify-center",children:[e.jsx("div",{className:"w-full md:w-[1100px] flex flex-col items-center md:items-start",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-blue-200 p-12 w-full max-w-5xl transition-all",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(X,{className:"text-2xl text-blue-600"}),e.jsx("h3",{className:"text-xl font-bold text-blue-700",children:"Disponibilidad de Médicos"})]}),e.jsx(se,{})]})}),e.jsx("div",{className:"w-full md:w-[700px] flex flex-col items-center md:items-start",children:e.jsx(te,{tipoConsulta:u,setTipoConsulta:j,medicos:M,tarifas:$,medicoId:x,setMedicoId:H,fecha:s,setFecha:r,hora:l,setHora:g,horariosDisponibles:R,cargandoHorarios:V,handleSubmit:G,msg:f})})]})]})}function ce(){const a=I(),p=J(),u=a.state?.pacienteId||new URLSearchParams(a.search).get("paciente_id");return u?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("h1",{className:"text-2xl font-bold text-blue-800",children:"Agendar Consulta Médica"})}),e.jsx(oe,{pacienteId:u})]})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"bg-white p-6 rounded shadow text-center",children:[e.jsx("p",{className:"text-lg font-bold text-red-600 mb-2",children:"No se ha seleccionado un paciente."}),e.jsx("button",{onClick:()=>p(-1),className:"bg-blue-500 text-white px-4 py-2 rounded",children:"Volver"})]})})}export{ce as default};
