import{r as b,t as te,u as ae,k as se,j as o,S as v}from"./vendor-B5yQt2qK.js";import{C as ce}from"./CobroModuloFinal-Vv0lAaBv.js";import{B as _}from"./examenes-laboratorio-crud-BJk1fG4Z.js";function ue(){const[A,J]=b.useState([]),[B,I]=b.useState(!1),[V,G]=b.useState([]),[H,K]=b.useState(0),{pacienteId:w}=te(),O=ae(),h=se(),[y,W]=b.useState(null),[S,X]=b.useState([]),[g,P]=b.useState([]),[j,C]=b.useState({}),[M,T]=b.useState(""),[k,U]=b.useState({}),[q,L]=b.useState([]),[z,R]=b.useState(null),[Q,Y]=b.useState(""),F=S.filter(r=>{const i=`${r.descripcion||r.nombre}`.toLowerCase();let e=null;r&&r.medico_id&&(e=A.find(m=>m.id===r.medico_id));const n=e?`${e.nombres||e.nombre} ${e.apellidos||e.apellido}`.toLowerCase():"sin doctor",u=Q.toLowerCase();return i.includes(u)||n.includes(u)});b.useEffect(()=>{fetch(`${_}api_pacientes.php?id=${w}`).then(r=>r.json()).then(r=>{r.success&&r.paciente&&W(r.paciente)}),fetch(`${_}api_tarifas.php`,{credentials:"include"}).then(r=>r.json()).then(r=>{const i=(r.tarifas||[]).filter(e=>e.servicio_tipo==="operacion").map(e=>({...e,id:Number(e.id),medico_id:e.medico_id!==void 0&&e.medico_id!==null?Number(e.medico_id):e.medico_id,precio_particular:Number(e.precio_particular||e.precio||0)}));X(i)}),fetch(`${_}api_medicos.php`,{credentials:"include"}).then(r=>r.json()).then(r=>{J(r.medicos||[])})},[w]),b.useEffect(()=>{fetch(`${_}api_caja_estado.php`,{credentials:"include"}).then(r=>r.json()).then(r=>R(r?.estado||"cerrada")).catch(()=>R("cerrada"))},[]),b.useEffect(()=>{const r=new URLSearchParams(h.search),i=r.get("cobro_id"),e=r.get("cotizacion_id"),n=[];(i||e)&&L([]),i&&n.push(fetch(`${_}api_cobros.php?cobro_id=${i}`,{credentials:"include"}).then(u=>u.json()).then(u=>{const m=u.cobro||u?.result?.cobro||null;if(!u.success||!m)return;const f=Array.isArray(m.detalles)?m.detalles:[],l=[];if(f.forEach(t=>{if((t.servicio_tipo||"").toLowerCase()==="operacion")try{const s=JSON.parse(t.descripcion);Array.isArray(s)&&l.push(...s)}catch{}}),l.length){L(a=>[...a,...l]);const t=Array.from(new Set(l.map(a=>Number(a.servicio_id)).filter(Boolean)));P(t);const s={},d={};l.forEach(a=>{const c=Number(a.servicio_id);s[c]=(s[c]||0)+Number(a.cantidad||1),d[c]=s[c]}),C(a=>({...a,...d})),U(s)}})),e&&n.push(fetch(`${_}api_cotizaciones.php?cotizacion_id=${e}`,{credentials:"include"}).then(u=>u.json()).then(u=>{const m=u.cotizacion||null;if(!u.success||!m)return;const l=(Array.isArray(m.detalles)?m.detalles:[]).filter(t=>(t.servicio_tipo||"").toLowerCase()==="operacion");if(l.length){L(a=>[...a,...l]);const t=Array.from(new Set(l.map(a=>Number(a.servicio_id)).filter(Boolean)));P(t);const s={},d={};l.forEach(a=>{const c=Number(a.servicio_id);s[c]=(s[c]||0)+Number(a.cantidad||1),d[c]=s[c]}),C(a=>({...a,...d})),U(s)}})),n.length&&Promise.all(n).catch(()=>{})},[h.search]);const Z=async()=>{const r=new URLSearchParams(h.search).get("cobro_id");if(!r)return;try{const t=await fetch(`${_}api_caja_estado.php`,{credentials:"include"}).then(s=>s.json());if(!t?.success||t?.estado!=="abierta"){R(t?.estado||"cerrada"),v.fire("Error","No hay caja abierta. Abre caja para actualizar este cobro.","error");return}R("abierta")}catch{v.fire("Error","No se pudo verificar el estado de la caja.","error");return}const i=new Set([...g.map(Number),...Object.keys(k||{}).map(Number)]),e=[],n=[];if(i.forEach(t=>{const d=g.includes(Number(t))?Number(j[t]||1):0,a=Number(k[t]||0),c=d-a;if(c>0){const p=S.find(x=>Number(x.id)===Number(t));if(!p)return;const $=p.descripcion&&p.descripcion!=="0"?p.descripcion:p.nombre||"Operaci√≥n";e.push({servicio_id:Number(t),descripcion:$,cantidad:c,precio_unitario:p.precio_particular,subtotal:p.precio_particular*c,medico_id:p.medico_id||"",especialidad:p.especialidad||""})}else c<0&&n.push({servicio_id:Number(t),cantidad_eliminar:Math.abs(c)})}),e.length===0&&n.length===0){v.fire("Sin cambios","No hay cambios para aplicar.","info");return}let u="";if(n.length>0){const t=await v.fire({title:"Motivo de la reducci√≥n/eliminaci√≥n",input:"text",inputPlaceholder:"Escribe un motivo",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",inputValidator:s=>{if(!s||!s.trim())return"Motivo requerido"}});if(!t.isConfirmed)return;u=(t.value||"").toString().trim()}let m=Array.isArray(q)?[...q]:[];const f=[...e],l=(t,s,d)=>{let a=-1,c=-1,p=-1,$=-1;for(let x=0;x<t.length;x++){const E=t[x];if(Number(E?.servicio_id)!==Number(s))continue;const N=Number(E?.cantidad||0);if(!(N<=0)){if(N===d){a=x;break}N>d&&(c===-1||N<Number(t[c]?.cantidad||0))&&(c=x),N>$&&($=N,p=x)}}return a!==-1?a:c!==-1?c:p};try{for(const s of n){let d=Number(s.cantidad_eliminar||0);for(;d>0;){const a=l(m,s.servicio_id,d);if(a===-1)throw new Error("No se encontr√≥ el √≠tem a reducir en el cobro.");const c=m[a],p=Number(c?.cantidad||0);if(p<=0)throw new Error("Cantidad inv√°lida en el detalle del cobro.");const x=await(await fetch(`${_}api_cobro_eliminar_item.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(r),servicio_tipo:"operacion",item:c,motivo:u})})).json();if(!x?.success)throw new Error(x?.error||"No se pudo eliminar el √≠tem del cobro.");if(m.splice(a,1),p>d){const E=p-d,N=Number(c?.precio_unitario||0)||Number(c?.subtotal||0)/Math.max(1,p);f.push({...c,cantidad:E,precio_unitario:N,subtotal:N*E}),d=0}else d-=p}}if(f.length>0){const d=await(await fetch(`${_}api_cobro_actualizar.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(r),servicio_tipo:"operacion",items:f})})).json();if(!d?.success)throw new Error(d?.error||"No se pudo actualizar el cobro");m=[...m,...f]}const t={};i.forEach(s=>{const a=g.includes(Number(s))?Number(j[s]||1):0;a>0&&(t[Number(s)]=a)}),U(t),L(m),v.fire("Actualizado","Se aplicaron los cambios en el cobro.","success")}catch(t){v.fire("Error",t?.message||"Fallo de conexi√≥n con el servidor","error")}},ee=r=>{const i=Number(r);P(e=>e.includes(i)?e:[...e,i]),C(e=>({...e,[i]:1}))},re=r=>{const i=Number(r);P(e=>e.filter(n=>n!==i)),C(e=>{const n={...e};return delete n[i],n})},oe=(r,i)=>{const e=Number(r);C(n=>({...n,[e]:i}))},D=()=>g.reduce((r,i)=>{const e=S.find(u=>Number(u.id)===Number(i)),n=j[i]||1;return e?r+e.precio_particular*n:r},0),ie=async()=>{if(g.length===0){T("Selecciona al menos una operaci√≥n/cirug√≠a.");return}const r=g.map(i=>{const e=S.find(l=>Number(l.id)===Number(i)),n=j[i]||1;let m=e&&e.descripcion&&e.descripcion!=="0"?e.descripcion:e&&e.nombre&&e.nombre!=="0"?e.nombre:"Operaci√≥n sin nombre",f="";if(e&&e.medico_id!==void 0&&e.medico_id!==null){const l=A.find(t=>Number(t.id)===Number(e.medico_id));l&&(f=`${l.nombres||l.nombre} ${l.apellidos||l.apellido}`)}return e?{servicio_tipo:"operacion",servicio_id:i,descripcion:m,cantidad:n,precio_unitario:e.precio_particular,subtotal:e.precio_particular*n,medico_id:e.medico_id||"",medico_nombre:f,especialidad:e.especialidad||""}:null}).filter(Boolean);G(r),K(D()),I(!0)};return o.jsxs("div",{className:"max-w-7xl mx-auto p-10 bg-white rounded-2xl shadow-2xl mt-8 border border-blue-100",children:[(()=>{const r=new URLSearchParams(h.search),i=r.get("cobro_id"),e=r.get("cotizacion_id");return!(i||e)?o.jsx("button",{onClick:()=>O("/seleccionar-servicio",{state:{pacienteId:w}}),className:"mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-semibold",children:"‚Üê Volver"}):o.jsx("button",{onClick:()=>O(w?`/consumo-paciente/${w}${i?`?cobro_id=${i}`:""}`:"/pacientes"),className:"mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-semibold",children:"‚Üê Volver a Consumo del Paciente"})})(),o.jsxs("h2",{className:"text-2xl font-bold text-blue-900 mb-4 flex items-center gap-2",children:[o.jsx("span",{role:"img","aria-label":"operacion",children:"ü©º"})," Cotizador de Operaciones/Cirug√≠as Mayores",(new URLSearchParams(h.search).get("cobro_id")||new URLSearchParams(h.search).get("cotizacion_id"))&&o.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-300",children:new URLSearchParams(h.search).get("cobro_id")?`Editando cobro #${new URLSearchParams(h.search).get("cobro_id")}`:`Editando cotizaci√≥n #${new URLSearchParams(h.search).get("cotizacion_id")}`})]}),y&&o.jsxs("div",{className:"mb-4 p-2 bg-blue-50 rounded text-blue-800 text-sm",children:[o.jsx("span",{className:"font-bold",children:"Paciente:"})," ",y.nombres||y.nombre," ",y.apellidos||y.apellido," (DNI: ",y.dni,")"]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[o.jsxs("div",{className:"mb-4 max-h-[500px] overflow-y-auto md:max-w-xl mx-auto",children:[o.jsxs("div",{className:"font-bold mb-2 flex flex-col gap-2",children:[o.jsx("span",{children:"Operaciones/Cirug√≠as disponibles:"}),o.jsx("input",{type:"text",placeholder:"Buscar operaci√≥n/cirug√≠a...",value:Q,onChange:r=>Y(r.target.value),className:"border px-3 py-2 rounded-lg w-full max-w-md"})]}),F.length===0?o.jsx("div",{className:"text-gray-500",children:"No hay operaciones/cirug√≠as registradas."}):o.jsx("ul",{className:"divide-y divide-gray-100",children:F.map(r=>o.jsxs("li",{className:"flex items-center gap-4 py-3 px-2 hover:bg-blue-50 rounded-lg transition-all",children:[o.jsxs("div",{className:"flex-1",children:[o.jsx("div",{className:"font-semibold text-gray-800",children:r.descripcion||r.nombre}),o.jsxs("div",{className:"text-xs text-gray-500",children:["Precio: S/ ",r.precio_particular]}),o.jsxs("div",{className:"text-xs text-blue-700 mt-1",children:["Doctor: ",(()=>{if(r.medico_id!==void 0&&r.medico_id!==null){const i=A.find(e=>Number(e.id)===Number(r.medico_id));if(i)return`${i.nombres||i.nombre} ${i.apellidos||i.apellido}`}return"Sin doctor"})()]})]}),g.includes(Number(r.id))?o.jsxs(o.Fragment,{children:[o.jsx("input",{type:"number",min:1,value:j[Number(r.id)]||1,onChange:i=>oe(Number(r.id),Math.max(1,Number(i.target.value))),className:"border rounded-lg px-2 w-16 bg-white"}),o.jsx("button",{onClick:()=>re(Number(r.id)),className:"ml-2 w-10 h-10 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-700 text-xl shadow transition","aria-label":"Quitar",children:"‚úï"})]}):o.jsx("button",{onClick:()=>ee(Number(r.id)),className:"w-10 h-10 flex items-center justify-center rounded-full bg-green-100 hover:bg-green-200 text-green-700 text-xl shadow transition","aria-label":"Agregar",children:"+"})]},r.id))})]}),g.length>0&&!B&&o.jsxs("div",{className:"bg-blue-50 rounded-2xl p-6 border border-blue-200 shadow mb-4 max-h-[500px] overflow-y-auto",children:[o.jsxs("h4",{className:"font-semibold text-blue-700 mb-4 flex items-center gap-2",children:[o.jsx("span",{children:"üìù"}),"Resumen de Cotizaci√≥n"]}),o.jsx("ul",{className:"divide-y divide-gray-100 mb-2",children:g.map(r=>{const i=S.find(n=>n.id===r),e=j[r]||1;return i?o.jsxs("li",{className:"py-2 flex justify-between items-center",children:[o.jsx("span",{children:i.descripcion||i.nombre}),o.jsxs("span",{children:[e," estudio(s)"]}),o.jsxs("span",{className:"font-bold text-green-700",children:["S/ ",(i.precio_particular*e).toFixed(2)]})]},r):null})}),o.jsxs("div",{className:"text-right text-xl font-bold text-blue-800 flex items-center gap-2",children:["Total: ",o.jsx("span",{children:"üí≤"})," S/ ",D().toFixed(2)]}),new URLSearchParams(h.search).get("cobro_id")?o.jsxs("button",{onClick:Z,disabled:z==="cerrada",className:`mt-6 px-8 py-3 rounded-xl font-bold flex items-center gap-2 text-lg ${z==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:[o.jsx("span",{children:"üîÑ"}),"Actualizar cobro"]}):o.jsxs("button",{onClick:ie,disabled:z==="cerrada",className:`mt-6 px-8 py-3 rounded-xl font-bold flex items-center gap-2 text-lg ${z==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:[o.jsx("span",{children:"üõí"}),"Registrar Cotizaci√≥n"]}),(new URLSearchParams(h.search).get("cobro_id")||!new URLSearchParams(h.search).get("cobro_id"))&&z==="cerrada"&&o.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[o.jsxs("span",{className:"text-sm text-red-600",children:["Caja cerrada: abre una caja para poder ",new URLSearchParams(h.search).get("cobro_id")?"actualizar":"cobrar","."]}),o.jsx("button",{onClick:()=>O("/contabilidad"),className:"text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded border border-yellow-300 hover:bg-yellow-200",children:"Ir a Contabilidad"})]})]}),B&&y&&o.jsx("div",{className:"w-full md:max-w-xl mx-auto",children:o.jsx(ce,{paciente:y,servicio:{key:"operacion",label:"Operaciones/Cirug√≠as Mayores"},detalles:V,total:H,onCobroCompleto:()=>{I(!1),T("Cotizaci√≥n procesada correctamente.")},onCancelar:()=>I(!1)})})]}),M&&o.jsx("div",{className:"mt-4 text-center font-semibold text-green-600",children:M})]})}export{ue as default};
