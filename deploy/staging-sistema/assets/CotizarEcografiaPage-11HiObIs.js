import{r as l,t as se,u as ce,k as ne,j as t,S as w}from"./vendor-B5yQt2qK.js";import{C as de}from"./CobroModuloFinal-Vv0lAaBv.js";import{B as y}from"./examenes-laboratorio-crud-BJk1fG4Z.js";function be(){const[R,V]=l.useState(""),[M,I]=l.useState(!1),[G,H]=l.useState([]),[K,W]=l.useState(0),{pacienteId:S}=se(),A=ce(),h=ne(),[x,X]=l.useState(null),[g,Y]=l.useState([]),[U,Z]=l.useState([]),[N,T]=l.useState([]),[v,$]=l.useState({}),[B,Q]=l.useState(""),[q,F]=l.useState({}),[C,P]=l.useState(null),[k,O]=l.useState([]),[D,L]=l.useState([]),ee=g.filter(r=>{const i=`${r.descripcion||r.nombre}`.toLowerCase();let e=null;r&&r.medico_id!==void 0&&r.medico_id!==null&&(e=U.find(s=>Number(s.id)===Number(r.medico_id)));const a=e?`${e.nombres||e.nombre} ${e.apellidos||e.apellido}`.toLowerCase():"sin doctor";return i.includes(R.toLowerCase())||a.includes(R.toLowerCase())});l.useEffect(()=>{fetch(`${y}api_pacientes.php?id=${S}`).then(r=>r.json()).then(r=>{r.success&&r.paciente&&X(r.paciente)}),fetch(`${y}api_tarifas.php`,{credentials:"include"}).then(r=>r.json()).then(r=>{const i=(r.tarifas||[]).filter(e=>e.servicio_tipo==="ecografia").map(e=>({...e,id:Number(e.id),medico_id:e.medico_id!==void 0&&e.medico_id!==null?Number(e.medico_id):e.medico_id,precio_particular:Number(e.precio_particular||e.precio||0)}));Y(i)}),fetch(`${y}api_medicos.php`,{credentials:"include"}).then(r=>r.json()).then(r=>{Z(r.medicos||[])})},[S]),l.useEffect(()=>{fetch(`${y}api_caja_estado.php`,{credentials:"include"}).then(r=>r.json()).then(r=>P(r?.estado||"cerrada")).catch(()=>P("cerrada"))},[]),l.useEffect(()=>{const r=new URLSearchParams(h.search),i=r.get("cobro_id"),e=r.get("cotizacion_id"),a=[];(i||e)&&L([]),i&&a.push(fetch(`${y}api_cobros.php?cobro_id=${i}`,{credentials:"include"}).then(s=>s.json()).then(s=>{const d=s.cobro||s?.result?.cobro||null;if(!s.success||!d)return;const p=Array.isArray(d.detalles)?d.detalles:[],c=[];p.forEach(o=>{if((o.servicio_tipo||"").toLowerCase()==="ecografia")try{const n=JSON.parse(o.descripcion);Array.isArray(n)?c.push(...n):n&&typeof n=="object"&&c.push(n)}catch{c.push({descripcion:o.descripcion,cantidad:o.cantidad||1})}}),c.length&&O(o=>[...o,...c]),c.length&&L(o=>[...o,...c])})),e&&a.push(fetch(`${y}api_cotizaciones.php?cotizacion_id=${e}`,{credentials:"include"}).then(s=>s.json()).then(s=>{const d=s.cotizacion||null;if(!s.success||!d)return;const c=(Array.isArray(d.detalles)?d.detalles:[]).filter(o=>(o.servicio_tipo||"").toLowerCase()==="ecografia").map(o=>({servicio_id:o.servicio_id,descripcion:o.descripcion,cantidad:o.cantidad,precio_unitario:o.precio_unitario,subtotal:o.subtotal}));c.length&&O(o=>[...o,...c]),c.length&&L(o=>[...o,...c])})),a.length&&Promise.all(a).catch(()=>{})},[h.search]),l.useEffect(()=>{if(!k.length||!g.length)return;const r=[],i={};k.forEach(a=>{let s=Number(a.servicio_id);if(!s||Number.isNaN(s)){const d=o=>(o||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim(),p=d(a.descripcion),c=g.find(o=>{const n=d(o.descripcion||o.nombre||"");return n===p||n.includes(p)||p.includes(n)});c&&(s=Number(c.id))}s&&!Number.isNaN(s)&&(r.push(s),i[s]=(i[s]||0)+Number(a.cantidad||1))});const e=Array.from(new Set(r));T(e),$(a=>({...a,...i})),F(i)},[k,g]);const re=async()=>{const r=new URLSearchParams(h.search).get("cobro_id");if(!r)return;try{const o=await fetch(`${y}api_caja_estado.php`,{credentials:"include"}).then(n=>n.json());if(!o?.success||o?.estado!=="abierta"){P(o?.estado||"cerrada"),w.fire("Error","No hay caja abierta. Abre caja para actualizar este cobro.","error");return}P("abierta")}catch{w.fire("Error","No se pudo verificar el estado de la caja.","error");return}const i=new Set([...N.map(Number),...Object.keys(q||{}).map(Number)]),e=[],a=[];if(i.forEach(o=>{const b=N.includes(Number(o))?Number(v[o]||1):0,f=Number(q[o]||0),u=b-f;if(u>0){const m=g.find(E=>Number(E.id)===Number(o));if(!m)return;e.push({servicio_id:Number(o),descripcion:m.descripcion||m.nombre,cantidad:u,precio_unitario:m.precio_particular,subtotal:m.precio_particular*u,medico_id:m.medico_id||"",especialidad:m.especialidad||""})}else u<0&&a.push({servicio_id:Number(o),cantidad_eliminar:Math.abs(u)})}),e.length===0&&a.length===0){w.fire("Sin cambios","No hay cambios para aplicar.","info");return}let s="";if(a.length>0){const o=await w.fire({title:"Motivo de la reducci√≥n/eliminaci√≥n",input:"text",inputPlaceholder:"Escribe un motivo",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",inputValidator:n=>{if(!n||!n.trim())return"Motivo requerido"}});if(!o.isConfirmed)return;s=(o.value||"").toString().trim()}let d=Array.isArray(D)?[...D]:[];const p=[...e],c=(o,n,b)=>{let f=-1,u=-1,m=-1,E=-1;for(let _=0;_<o.length;_++){const z=o[_];if(Number(z?.servicio_id)!==Number(n))continue;const j=Number(z?.cantidad||0);if(!(j<=0)){if(j===b){f=_;break}j>b&&(u===-1||j<Number(o[u]?.cantidad||0))&&(u=_),j>E&&(E=j,m=_)}}return f!==-1?f:u!==-1?u:m};try{for(const n of a){let b=Number(n.cantidad_eliminar||0);for(;b>0;){const f=c(d,n.servicio_id,b);if(f===-1)throw new Error("No se encontr√≥ el √≠tem a reducir en el cobro.");const u=d[f],m=Number(u?.cantidad||0);if(m<=0)throw new Error("Cantidad inv√°lida en el detalle del cobro.");const _=await(await fetch(`${y}api_cobro_eliminar_item.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(r),servicio_tipo:"ecografia",item:u,motivo:s})})).json();if(!_?.success)throw new Error(_?.error||"No se pudo eliminar el √≠tem del cobro.");if(d.splice(f,1),m>b){const z=m-b,j=Number(u?.precio_unitario||0)||Number(u?.subtotal||0)/Math.max(1,m);p.push({...u,cantidad:z,precio_unitario:j,subtotal:j*z}),b=0}else b-=m}}if(p.length>0){const b=await(await fetch(`${y}api_cobro_actualizar.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(r),servicio_tipo:"ecografia",items:p})})).json();if(!b?.success)throw new Error(b?.error||"No se pudo actualizar el cobro");d=[...d,...p]}const o={};i.forEach(n=>{const f=N.includes(Number(n))?Number(v[n]||1):0;f>0&&(o[Number(n)]=f)}),F(o),L(d),w.fire("Actualizado","Se aplicaron los cambios en el cobro.","success")}catch(o){w.fire("Error",o?.message||"Fallo de conexi√≥n con el servidor","error")}},oe=r=>{const i=Number(r);T(e=>e.includes(i)?e:[...e,i]),$(e=>({...e,[i]:1}))},ie=r=>{const i=Number(r);T(e=>e.filter(a=>a!==i)),$(e=>{const a={...e};return delete a[i],a})},te=(r,i)=>{const e=Number(r);$(a=>({...a,[e]:i}))},J=()=>N.reduce((r,i)=>{const e=g.find(s=>Number(s.id)===Number(i)),a=v[i]||1;return e?r+e.precio_particular*a:r},0),ae=async()=>{if(N.length===0){Q("Selecciona al menos una ecograf√≠a.");return}const r=N.map(i=>{const e=g.find(c=>Number(c.id)===Number(i)),a=v[i]||1;let d=e&&e.descripcion&&e.descripcion!=="0"?e.descripcion:e&&e.nombre&&e.nombre!=="0"?e.nombre:"Ecograf√≠a sin nombre",p="";if(e&&e.medico_id!==void 0&&e.medico_id!==null){const c=U.find(o=>Number(o.id)===Number(e.medico_id));c&&(p=`${c.nombres||c.nombre} ${c.apellidos||c.apellido}`)}return e?{servicio_tipo:"ecografia",servicio_id:i,descripcion:d,cantidad:a,precio_unitario:e.precio_particular,subtotal:e.precio_particular*a,medico_id:e.medico_id||"",medico_nombre:p,especialidad:e.especialidad||"",paciente_id:x?.id}:null}).filter(Boolean);H(r),W(J()),I(!0)};return t.jsxs("div",{className:"max-w-7xl mx-auto p-10 bg-white rounded-2xl shadow-2xl mt-8 border border-blue-100",children:[(()=>{const r=new URLSearchParams(h.search),i=r.get("cobro_id"),e=r.get("cotizacion_id");return!(i||e)?t.jsx("button",{onClick:()=>A("/seleccionar-servicio",{state:{pacienteId:S}}),className:"mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-semibold",children:"‚Üê Volver"}):t.jsx("button",{onClick:()=>A(S?`/consumo-paciente/${S}${i?`?cobro_id=${i}`:""}`:"/pacientes"),className:"mb-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-semibold",children:"‚Üê Volver a Consumo del Paciente"})})(),t.jsxs("h2",{className:"text-2xl font-bold text-blue-900 mb-4 flex items-center gap-2",children:[t.jsx("span",{role:"img","aria-label":"eco",children:"üì°"})," Cotizador de Ecograf√≠as",(new URLSearchParams(h.search).get("cobro_id")||new URLSearchParams(h.search).get("cotizacion_id"))&&t.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-300",children:new URLSearchParams(h.search).get("cobro_id")?`Editando cobro #${new URLSearchParams(h.search).get("cobro_id")}`:`Editando cotizaci√≥n #${new URLSearchParams(h.search).get("cotizacion_id")}`})]}),x&&t.jsxs("div",{className:"mb-4 p-2 bg-blue-50 rounded text-blue-800 text-sm",children:[t.jsx("span",{className:"font-bold",children:"Paciente:"})," ",x.nombres||x.nombre," ",x.apellidos||x.apellido," (DNI: ",x.dni,")"]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[t.jsxs("div",{className:"mb-4 max-h-[500px] overflow-y-auto",children:[t.jsxs("div",{className:"font-bold mb-2 flex flex-col gap-2",children:[t.jsx("span",{children:"Ecograf√≠as disponibles:"}),t.jsx("input",{type:"text",placeholder:"Buscar ecograf√≠a, descripci√≥n o doctor...",value:R,onChange:r=>V(r.target.value),className:"border px-3 py-2 rounded-lg w-full max-w-md"})]}),g.length===0?t.jsx("div",{className:"text-gray-500",children:"No hay ecograf√≠as registradas."}):t.jsx("ul",{className:"divide-y divide-gray-100",children:ee.map(r=>{let i=null;return r&&r.medico_id!==void 0&&r.medico_id!==null&&(i=U.find(e=>Number(e.id)===Number(r.medico_id))),t.jsxs("li",{className:"flex items-center gap-4 py-3 px-2 hover:bg-blue-50 rounded-lg transition-all",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-semibold text-gray-800",children:r.descripcion||r.nombre}),t.jsxs("div",{className:"text-xs text-gray-500",children:["Precio: S/ ",r.precio_particular]}),t.jsxs("div",{className:"text-xs text-blue-700 mt-1",children:["Doctor: ",i?`${i.nombres||i.nombre} ${i.apellidos||i.apellido}`:"Sin doctor"]})]}),N.includes(Number(r.id))?t.jsxs(t.Fragment,{children:[t.jsx("input",{type:"number",min:1,value:v[Number(r.id)]||1,onChange:e=>te(Number(r.id),Math.max(1,Number(e.target.value))),className:"border rounded-lg px-2 w-16 bg-white"}),t.jsx("button",{onClick:()=>ie(Number(r.id)),className:"ml-2 w-10 h-10 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 text-red-700 text-xl shadow transition","aria-label":"Quitar",children:"‚úï"})]}):t.jsx("button",{onClick:()=>oe(Number(r.id)),className:"w-10 h-10 flex items-center justify-center rounded-full bg-green-100 hover:bg-green-200 text-green-700 text-xl shadow transition","aria-label":"Agregar",children:"+"})]},r.id)})})]}),N.length>0&&!M&&t.jsxs("div",{className:"bg-blue-50 rounded-2xl p-6 border border-blue-200 shadow mb-4 max-h-[500px] overflow-y-auto",children:[t.jsxs("h4",{className:"font-semibold text-blue-700 mb-4 flex items-center gap-2",children:[t.jsx("span",{children:"üìù"}),"Resumen de Cotizaci√≥n"]}),t.jsx("ul",{className:"divide-y divide-gray-100 mb-2",children:N.map(r=>{const i=g.find(a=>Number(a.id)===Number(r)),e=v[r]||1;return i?t.jsxs("li",{className:"py-2 flex justify-between items-center",children:[t.jsx("span",{children:i.descripcion||i.nombre}),t.jsxs("span",{children:[e," estudio(s)"]}),t.jsxs("span",{className:"font-bold text-green-700",children:["S/ ",(i.precio_particular*e).toFixed(2)]})]},r):null})}),t.jsxs("div",{className:"text-right text-xl font-bold text-blue-800 flex items-center gap-2",children:["Total: ",t.jsx("span",{children:"üí≤"})," S/ ",J().toFixed(2)]}),new URLSearchParams(h.search).get("cobro_id")?t.jsxs("button",{onClick:re,disabled:C==="cerrada",className:`mt-6 px-8 py-3 rounded-xl font-bold flex items-center gap-2 text-lg ${C==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:[t.jsx("span",{children:"üîÑ"}),"Actualizar cobro"]}):t.jsxs("button",{onClick:ae,disabled:C==="cerrada",className:`mt-6 px-8 py-3 rounded-xl font-bold flex items-center gap-2 text-lg ${C==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:[t.jsx("span",{children:"üõí"}),"Registrar Cotizaci√≥n"]}),(new URLSearchParams(h.search).get("cobro_id")||!new URLSearchParams(h.search).get("cobro_id"))&&C==="cerrada"&&t.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[t.jsxs("span",{className:"text-sm text-red-600",children:["Caja cerrada: abre una caja para poder ",new URLSearchParams(h.search).get("cobro_id")?"actualizar":"cobrar","."]}),t.jsx("button",{onClick:()=>A("/contabilidad"),className:"text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded border border-yellow-300 hover:bg-yellow-200",children:"Ir a Contabilidad"})]})]}),M&&x&&t.jsx(de,{paciente:x,servicio:{key:"ecografia",label:"Ecograf√≠a"},detalles:G,total:K,onCobroCompleto:()=>{I(!1),Q("Cotizaci√≥n procesada correctamente.")},onCancelar:()=>I(!1)})]}),B&&t.jsx("div",{className:"mt-4 text-center font-semibold text-green-600",children:B})]})}export{be as default};
