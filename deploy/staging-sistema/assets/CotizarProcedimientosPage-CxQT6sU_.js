import{t as re,u as ie,k as oe,r as b,j as r,S as C}from"./vendor-B5yQt2qK.js";import{C as ae}from"./CobroModuloFinal-Vv0lAaBv.js";import{B as y}from"./examenes-laboratorio-crud-BJk1fG4Z.js";function de(){const{pacienteId:_}=re(),k=ie(),p=oe(),[P,D]=b.useState([]),[x,j]=b.useState([]),[S,v]=b.useState({}),[T,$]=b.useState(!1),[J,V]=b.useState([]),[G,H]=b.useState(0),[U,R]=b.useState(""),[N,K]=b.useState(null),[q,B]=b.useState({}),[M,I]=b.useState([]),[z,A]=b.useState(null),[F,W]=b.useState(""),O=P.filter(e=>`${e.descripcion||e.nombre}`.toLowerCase().includes(F.toLowerCase()));b.useEffect(()=>{fetch(`${y}api_tarifas.php`,{credentials:"include"}).then(e=>e.json()).then(e=>{const i=(e.tarifas||[]).filter(t=>(t.servicio_tipo==="procedimiento"||t.servicio_tipo==="procedimientos")&&t.activo===1).map(t=>({...t,id:Number(t.id),precio_particular:Number(t.precio_particular||t.precio||0)}));D(i)}),fetch(`${y}api_pacientes.php?id=${_}`).then(e=>e.json()).then(e=>{e.success&&e.paciente&&K(e.paciente)}),j([]),v({}),$(!1),R("")},[_]),b.useEffect(()=>{fetch(`${y}api_caja_estado.php`,{credentials:"include"}).then(e=>e.json()).then(e=>A(e?.estado||"cerrada")).catch(()=>A("cerrada"))},[]),b.useEffect(()=>{const e=new URLSearchParams(p.search),i=e.get("cobro_id"),t=e.get("cotizacion_id"),n=[];(i||t)&&I([]),i&&n.push(fetch(`${y}api_cobros.php?cobro_id=${i}`,{credentials:"include"}).then(l=>l.json()).then(l=>{const m=l.cobro||l?.result?.cobro||null;if(!l.success||!m)return;const w=Array.isArray(m.detalles)?m.detalles:[],h=[];if(w.forEach(o=>{const a=(o.servicio_tipo||"").toLowerCase();if(a==="procedimiento"||a==="procedimientos")try{const d=JSON.parse(o.descripcion);Array.isArray(d)&&h.push(...d)}catch{}}),h.length){I(s=>[...s,...h]);const o=Array.from(new Set(h.map(s=>Number(s.servicio_id)).filter(Boolean)));j(o);const a={},d={};h.forEach(s=>{const c=Number(s.servicio_id);a[c]=(a[c]||0)+Number(s.cantidad||1),d[c]=a[c]}),v(s=>({...s,...d})),B(a)}})),t&&n.push(fetch(`${y}api_cotizaciones.php?cotizacion_id=${t}`,{credentials:"include"}).then(l=>l.json()).then(l=>{const m=l.cotizacion||null;if(!l.success||!m)return;const h=(Array.isArray(m.detalles)?m.detalles:[]).filter(o=>{const a=(o.servicio_tipo||"").toLowerCase();return a==="procedimiento"||a==="procedimientos"});if(h.length){I(s=>[...s,...h]);const o=Array.from(new Set(h.map(s=>Number(s.servicio_id)).filter(Boolean)));j(o);const a={},d={};h.forEach(s=>{const c=Number(s.servicio_id);a[c]=(a[c]||0)+Number(s.cantidad||1),d[c]=a[c]}),v(s=>({...s,...d})),B(a)}})),n.length&&Promise.all(n).catch(()=>{})},[p.search]);const X=async()=>{const e=new URLSearchParams(p.search).get("cobro_id");if(!e)return;try{const o=await fetch(`${y}api_caja_estado.php`,{credentials:"include"}).then(a=>a.json());if(!o?.success||o?.estado!=="abierta"){A(o?.estado||"cerrada"),C.fire("Error","No hay caja abierta. Abre caja para actualizar este cobro.","error");return}A("abierta")}catch{C.fire("Error","No se pudo verificar el estado de la caja.","error");return}const i=new Set([...x.map(Number),...Object.keys(q||{}).map(Number)]),t=[],n=[];if(i.forEach(o=>{const d=x.includes(Number(o))?Number(S[o]||1):0,s=Number(q[o]||0),c=d-s;if(c>0){const u=P.find(f=>Number(f.id)===Number(o));if(!u)return;const E=u.descripcion&&u.descripcion!=="0"?u.descripcion:u.nombre||"Procedimiento";t.push({servicio_id:Number(o),descripcion:E,cantidad:c,precio_unitario:u.precio_particular,subtotal:u.precio_particular*c})}else c<0&&n.push({servicio_id:Number(o),cantidad_eliminar:Math.abs(c)})}),t.length===0&&n.length===0){C.fire("Sin cambios","No hay cambios para aplicar.","info");return}let l="";if(n.length>0){const o=await C.fire({title:"Motivo de la reducci√≥n/eliminaci√≥n",input:"text",inputPlaceholder:"Escribe un motivo",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",inputValidator:a=>{if(!a||!a.trim())return"Motivo requerido"}});if(!o.isConfirmed)return;l=(o.value||"").toString().trim()}let m=Array.isArray(M)?[...M]:[];const w=[...t],h=(o,a,d)=>{let s=-1,c=-1,u=-1,E=-1;for(let f=0;f<o.length;f++){const L=o[f];if(Number(L?.servicio_id)!==Number(a))continue;const g=Number(L?.cantidad||0);if(!(g<=0)){if(g===d){s=f;break}g>d&&(c===-1||g<Number(o[c]?.cantidad||0))&&(c=f),g>E&&(E=g,u=f)}}return s!==-1?s:c!==-1?c:u};try{for(const a of n){let d=Number(a.cantidad_eliminar||0);for(;d>0;){const s=h(m,a.servicio_id,d);if(s===-1)throw new Error("No se encontr√≥ el √≠tem a reducir en el cobro.");const c=m[s],u=Number(c?.cantidad||0);if(u<=0)throw new Error("Cantidad inv√°lida en el detalle del cobro.");const f=await(await fetch(`${y}api_cobro_eliminar_item.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(e),servicio_tipo:"procedimiento",item:c,motivo:l})})).json();if(!f?.success)throw new Error(f?.error||"No se pudo eliminar el √≠tem del cobro.");if(m.splice(s,1),u>d){const L=u-d,g=Number(c?.precio_unitario||0)||Number(c?.subtotal||0)/Math.max(1,u);w.push({...c,cantidad:L,precio_unitario:g,subtotal:g*L}),d=0}else d-=u}}if(w.length>0){const d=await(await fetch(`${y}api_cobro_actualizar.php`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cobro_id:Number(e),servicio_tipo:"procedimiento",items:w})})).json();if(!d?.success)throw new Error(d?.error||"No se pudo actualizar el cobro");m=[...m,...w]}const o={};i.forEach(a=>{const s=x.includes(Number(a))?Number(S[a]||1):0;s>0&&(o[Number(a)]=s)}),B(o),I(m),C.fire("Actualizado","Se aplicaron los cambios en el cobro.","success")}catch(o){C.fire("Error",o?.message||"Fallo de conexi√≥n con el servidor","error")}},Y=e=>{const i=Number(e);j(t=>t.includes(i)?t:[...t,i]),v(t=>({...t,[i]:1}))},Z=e=>{const i=Number(e);j(t=>t.filter(n=>n!==i)),v(t=>{const n={...t};return delete n[i],n})},ee=(e,i)=>{const t=Number(e);v(n=>({...n,[t]:i}))},Q=()=>x.reduce((e,i)=>{const t=P.find(l=>Number(l.id)===Number(i)),n=S[i]||1;return t?e+t.precio_particular*n:e},0),te=()=>{if(x.length===0){R("Selecciona al menos un procedimiento.");return}const e=x.map(i=>{const t=P.find(m=>Number(m.id)===Number(i)),n=S[i]||1;let l=t&&t.descripcion?t.descripcion:t&&t.nombre?t.nombre:"";return(l===0||l==="0"||l===null||l===void 0)&&(l=t&&t.nombre?t.nombre:""),t?{servicio_tipo:"procedimiento",servicio_id:i,descripcion:l,cantidad:n,precio_unitario:t.precio_particular,subtotal:t.precio_particular*n}:null}).filter(Boolean);V(e),H(Q()),$(!0)};return r.jsxs("div",{className:"max-w-7xl mx-auto p-10 bg-white rounded-xl shadow-lg mt-8",children:[r.jsxs("div",{className:"flex items-center justify-between mb-6",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("span",{className:"text-3xl",children:"üõ†Ô∏è"}),r.jsx("h2",{className:"text-2xl font-bold text-blue-800",children:"Cotizaci√≥n de Procedimientos"}),(new URLSearchParams(p.search).get("cobro_id")||new URLSearchParams(p.search).get("cotizacion_id"))&&r.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-300",children:new URLSearchParams(p.search).get("cobro_id")?`Editando cobro #${new URLSearchParams(p.search).get("cobro_id")}`:`Editando cotizaci√≥n #${new URLSearchParams(p.search).get("cotizacion_id")}`})]}),(()=>{const e=new URLSearchParams(p.search),i=e.get("cobro_id"),t=e.get("cotizacion_id");return!(i||t)?r.jsx("button",{onClick:()=>k("/seleccionar-servicio",{state:{pacienteId:_}}),className:"bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300",children:"Volver"}):r.jsx("button",{onClick:()=>k(_?`/consumo-paciente/${_}${i?`?cobro_id=${i}`:""}`:"/pacientes"),className:"bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300",children:"‚Üê Volver a Consumo del Paciente"})})()]}),r.jsx("div",{className:"mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:r.jsxs("div",{className:"text-gray-600",children:[r.jsx("b",{children:"Paciente:"})," ",N?r.jsxs(r.Fragment,{children:[(N.nombres||N.nombre||"").trim()," ",(N.apellidos||N.apellido||"").trim(),N.dni?` (DNI: ${N.dni})`:""]}):r.jsxs(r.Fragment,{children:["ID ",_]})]})}),r.jsxs("div",{className:"flex flex-col md:flex-row gap-8",children:[r.jsx("div",{className:"flex-1 md:max-w-xl mx-auto",children:r.jsxs("div",{className:"mb-4",children:[r.jsx("h4",{className:"font-semibold mb-2",children:"Selecciona los procedimientos:"}),r.jsx("input",{type:"text",placeholder:"Buscar procedimiento...",value:F,onChange:e=>W(e.target.value),className:"border px-3 py-2 rounded-lg w-full max-w-md mb-2"}),O.length===0?r.jsx("div",{className:"text-center text-gray-500",children:"No hay procedimientos para mostrar."}):r.jsx("div",{className:"bg-white rounded-lg shadow border border-gray-200",children:r.jsx("ul",{className:"divide-y divide-gray-100",children:O.map(e=>r.jsxs("li",{className:"flex items-center px-4 py-3 hover:bg-blue-50 transition-colors",children:[r.jsx("input",{type:"checkbox",checked:x.includes(e.id),onChange:()=>x.includes(e.id)?Z(e.id):Y(e.id),className:"mr-3 accent-orange-600 w-5 h-5"}),r.jsx("div",{className:"flex-1",children:r.jsx("div",{className:"font-semibold text-gray-800",children:e.descripcion||e.nombre})}),r.jsxs("div",{className:"font-bold text-green-700 text-lg",children:["S/ ",e.precio_particular]}),x.includes(e.id)&&r.jsx("input",{type:"number",min:1,value:S[e.id]||1,onChange:i=>ee(e.id,Math.max(1,Number(i.target.value))),className:"border rounded-lg px-2 w-16 bg-white ml-2"})]},e.id))})})]})}),r.jsxs("div",{className:"w-full md:max-w-xl md:sticky md:top-8 h-fit",children:[x.length>0&&!T&&r.jsxs("div",{className:"mb-6",children:[r.jsx("h4",{className:"font-semibold text-gray-700 mb-2",children:"Lista de Cotizaci√≥n"}),r.jsx("ul",{className:"divide-y divide-gray-200 bg-gray-50 rounded-lg shadow p-4 max-h-80 overflow-y-auto",children:x.map(e=>{const i=P.find(n=>n.id===e),t=S[e]||1;return i?r.jsxs("li",{className:"py-2 flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[r.jsx("div",{children:r.jsx("span",{className:"font-medium text-gray-900",children:i.descripcion||i.nombre})}),r.jsxs("div",{className:"font-bold text-green-700 text-right",children:["S/ ",(i.precio_particular*t).toFixed(2)]})]},e):null})}),r.jsxs("div",{className:"mt-4 text-lg font-bold text-right",children:["Total: ",r.jsxs("span",{className:"text-green-600",children:["S/ ",Q().toFixed(2)]})]}),r.jsxs("div",{className:"flex gap-3 mt-4 justify-end",children:[r.jsx("button",{onClick:()=>{j([]),R("")},className:"bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200",children:"Limpiar selecci√≥n"}),new URLSearchParams(p.search).get("cobro_id")?r.jsx("button",{onClick:X,disabled:z==="cerrada",className:`px-6 py-2 rounded font-bold ${z==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:"Actualizar cobro"}):r.jsx("button",{onClick:te,disabled:z==="cerrada",className:`px-6 py-2 rounded font-bold ${z==="cerrada"?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:"Cotizar"}),(new URLSearchParams(p.search).get("cobro_id")||!new URLSearchParams(p.search).get("cobro_id"))&&z==="cerrada"&&r.jsxs("div",{className:"mt-2 flex items-center justify-end gap-2",children:[r.jsxs("span",{className:"text-sm text-red-600",children:["Caja cerrada: abre una caja para poder ",new URLSearchParams(p.search).get("cobro_id")?"actualizar":"cobrar","."]}),r.jsx("button",{onClick:()=>k("/contabilidad"),className:"text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded border border-yellow-300 hover:bg-yellow-200",children:"Ir a Contabilidad"})]})]})]}),T&&r.jsx(ae,{paciente:N,servicio:{key:"procedimiento",label:"Procedimiento"},detalles:J,total:G,onCobroCompleto:()=>{$(!1),j([]),v({}),R("Cotizaci√≥n procesada correctamente.")},onCancelar:()=>$(!1)})]})]}),U&&r.jsx("div",{className:`mt-6 text-center font-semibold ${U.includes("correctamente")?"text-green-600":"text-red-600"}`,children:U})]})}export{de as default};
